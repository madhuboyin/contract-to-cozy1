// Contract to Cozy - Database Schema
// Inspection + Handyman Categories
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  HOMEOWNER
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

// NEW ENUM to track the homeowner's current goal/state
enum HomeownerSegment {
  HOME_BUYER       // Actively in the closing process
  EXISTING_OWNER   // Standard homeowner focused on maintenance
}

// ADD THIS NEW ENUM
enum ChecklistItemStatus {
  PENDING
  COMPLETED
  NOT_NEEDED
}

// Add after the ChecklistItemStatus enum (around line 50)

// NEW: Service category configuration for segment targeting
model ServiceCategoryConfig {
  id            String          @id @default(uuid())
  category      ServiceCategory @unique
  
  // Segment targeting
  availableForHomeBuyer     Boolean @default(true)
  availableForExistingOwner Boolean @default(true)
  
  // Display properties
  displayName   String
  description   String?
  icon          String?         // Icon identifier for frontend
  sortOrder     Int    @default(0)
  
  // Status
  isActive      Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category])
  @@map("service_category_config")
}

enum ServiceCategory {
  INSPECTION          // HOME_BUYER primary
  HANDYMAN           // Both segments
  PLUMBING           // EXISTING_OWNER primary
  ELECTRICAL         // EXISTING_OWNER primary
  HVAC               // Both segments
  LANDSCAPING        // EXISTING_OWNER primary
  CLEANING           // Both segments (move-in for buyers, maintenance for owners)
  MOVING             // HOME_BUYER primary
  PEST_CONTROL       // Both segments
  LOCKSMITH          // Both segments
  INSURANCE
  ATTORNEY
  FINANCE            // EXISTING_OWNER - Property tax renewals
  WARRANTY           // EXISTING_OWNER - Warranty renewals
  ADMIN              // EXISTING_OWNER - Administrative reminders
}

enum InspectionType {
  HOME_INSPECTION
  PEST_INSPECTION
  RADON_TESTING
  MOLD_INSPECTION
  WELL_SEPTIC_INSPECTION
  ROOF_INSPECTION
  FOUNDATION_INSPECTION
  ELECTRICAL_INSPECTION
  PLUMBING_INSPECTION
}

enum HandymanType {
  MINOR_REPAIRS
  FIXTURE_INSTALLATION
  FURNITURE_ASSEMBLY
  DRYWALL_REPAIR
  DOOR_WINDOW_REPAIR
  DECK_FENCE_REPAIR
  GENERAL_MAINTENANCE
  PAINTING_TOUCHUP
  CAULKING_SEALING
}

enum BookingStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
  CANCELLED
}

enum DocumentType {
  INSPECTION_REPORT
  ESTIMATE
  INVOICE
  CONTRACT
  PERMIT
  PHOTO
  VIDEO
  INSURANCE_CERTIFICATE
  LICENSE
  OTHER
}

enum MessageType {
  TEXT
  SYSTEM
  BOOKING_UPDATE
  PAYMENT_UPDATE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum ProviderStatus {
  PENDING_APPROVAL
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  phone     String?
  firstName String
  lastName  String
  role      UserRole   @default(HOMEOWNER)
  status    UserStatus @default(ACTIVE)
  
  // Authentication
  passwordHash String
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)
  
  // Profile
  avatar       String?
  bio          String?
  address      Address?
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  homeownerProfile HomeownerProfile?
  providerProfile  ProviderProfile?
  bookings         Booking[]        @relation("BookingHomeowner")
  providerBookings Booking[]        @relation("BookingProvider")
  reviews          Review[]         @relation("ReviewAuthor")
  receivedReviews  Review[]         @relation("ReviewProvider")
  messages         Message[]
  notifications    Notification[]
  favorites        Favorite[]
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Address {
  id      String  @id @default(uuid())
  userId  String  @unique
  
  // Address components
  street1     String
  street2     String?
  city        String
  state       String
  zipCode     String
  country     String @default("USA")
  
  // Geocoding
  latitude    Float?
  longitude   Float?
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([zipCode])
  @@index([city, state])
  @@map("addresses")
}

// ============================================================================
// HOMEOWNER PROFILE
// ============================================================================

model HomeownerProfile {
  id     String @id @default(uuid())
  userId String @unique
  
  // NEW FIELD to identify the user's segment.
  // Defaults to EXISTING_OWNER for 100% backward compatibility.
  segment HomeownerSegment @default(EXISTING_OWNER)
  
  // Property Information
  propertyType        String? // Single Family, Condo, Townhouse, etc.
  propertySize        Int?    // Square footage
  yearBuilt           Int?
  bedrooms            Int?
  bathrooms           Float?
  
  // Purchase Information (for HOME_BUYER segment)
  closingDate         DateTime?
  purchasePrice       Decimal?  @db.Decimal(12, 2)
  
  // Preferences
  preferredContactMethod String? // email, phone, text
  notificationPreferences Json?  // Flexible JSON for various notification settings
  
  // Budget tracking
  totalBudget         Decimal? @db.Decimal(12, 2)
  spentAmount         Decimal   @default(0) @db.Decimal(12, 2)
  
  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties  Property[]
  checklist   Checklist?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("homeowner_profiles")
}

// ============================================================================
// HOME BUYER CHECKLIST
// ============================================================================

model Checklist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homeownerProfileId String           @unique
  homeownerProfile   HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)

  items ChecklistItem[]

  @@map("checklists")
}


// Update ChecklistItem model - add these fields:
model ChecklistItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?
  status      ChecklistItemStatus @default(PENDING)
  
  serviceCategory String?
  
  // NEW: Recurring task fields
  isRecurring        Boolean   @default(false)
  frequency          RecurrenceFrequency?
  nextDueDate        DateTime?
  lastCompletedDate  DateTime?

  checklistId String
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  sortOrder   Int @default(0)

  @@index([checklistId])
  @@map("checklist_items")
}

model Property {
  id                 String   @id @default(uuid())
  homeownerProfileId String
  
  // Property details
  name         String?  // e.g., "Main Home", "Investment Property"
  address     String
  city        String
  state       String
  zipCode     String
  
  isPrimary   Boolean  @default(true)
  
  // Relations
  homeownerProfile HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  bookings         Booking[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerProfileId])
  @@map("properties")
}

// ============================================================================
// PROVIDER PROFILE
// ============================================================================

model ProviderProfile {
  id     String @id @default(uuid())
  userId String @unique
  
  // Business Information
  businessName        String
  businessType        String? // LLC, Sole Proprietor, Corporation
  taxId               String?
  
  // Service Information
  serviceCategories   ServiceCategory[]
  serviceRadius       Int      @default(25)  // Miles
  
  // Verification
  status              ProviderStatus @default(PENDING_APPROVAL)
  backgroundCheckDate DateTime?
  insuranceVerified   Boolean        @default(false)
  licenseVerified     Boolean        @default(false)
  
  // Business Details
  yearsInBusiness     Int?
  teamSize            Int?
  description         String?
  website             String?
  
  // Ratings
  averageRating       Float    @default(0) @db.Real
  totalReviews        Int      @default(0)
  totalCompletedJobs  Int      @default(0)
  
  // Availability
  availabilitySchedule Json? // Weekly schedule
  
  // Stripe Connect
  stripeAccountId     String? @unique
  stripeOnboarded     Boolean  @default(false)
  
  // Relations
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  services           Service[]
  certifications     Certification[]
  portfolioImages    ProviderPortfolio[]
  bookings           Booking[]
  availability       ProviderAvailability[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([userId])
  @@map("provider_profiles")
}

model Certification {
  id                String   @id @default(uuid())
  providerProfileId String
  
  name              String
  issuingAuthority  String
  certificateNumber String?
  issueDate         DateTime
  expiryDate        DateTime?
  documentUrl       String?
  verified          Boolean  @default(false)
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@map("certifications")
}

model ProviderPortfolio {
  id                String  @id @default(uuid())
  providerProfileId String
  
  title             String
  description       String?
  imageUrl          String
  category          ServiceCategory
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([providerProfileId])
  @@map("provider_portfolio")
}

model ProviderAvailability {
  id                String   @id @default(uuid())
  providerProfileId String
  
  // Date range
  startDate         DateTime
  endDate           DateTime
  isAvailable       Boolean  @default(true)
  reason            String? // vacation, booked, etc.
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@index([startDate, endDate])
  @@map("provider_availability")
}

// ============================================================================
// SERVICES
// ============================================================================

model Service {
  id                String          @id @default(uuid())
  providerProfileId String
  
  // Service Details
  category          ServiceCategory
  inspectionType    InspectionType?
  handymanType      HandymanType?
  
  name              String
  description       String
  
  // Pricing
  basePrice         Decimal         @db.Decimal(10, 2)
  priceUnit         String          // "per hour", "per sqft", "flat rate"
  minimumCharge     Decimal? @db.Decimal(10, 2)
  
  // Availability
  isActive          Boolean         @default(true)
  estimatedDuration Int? // Minutes
  
  // Relations
  providerProfile   ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@index([category])
  @@index([isActive])
  @@map("services")
}

// ============================================================================
// BOOKING MANAGEMENT
// ============================================================================

model Booking {
  id                String        @id @default(uuid())
  bookingNumber     String        @unique // B-2025-001234
 
  
  // Parties
  homeownerId       String
  providerId        String
  providerProfileId String
  propertyId        String
  serviceId         String
  
  // Booking Details
  category          ServiceCategory
  status            BookingStatus   @default(PENDING)
  
  // Scheduling
  requestedDate     DateTime?
  scheduledDate     DateTime?
  startTime         DateTime?
  endTime           DateTime?
  actualStartTime   DateTime?
  actualEndTime     DateTime?
  
  // Pricing
  estimatedPrice    Decimal         @db.Decimal(10, 2)
  finalPrice        Decimal? @db.Decimal(10, 2)
  depositAmount     Decimal?        @db.Decimal(10, 2)
  
  // Details
  description       String
  specialRequests   String?
  internalNotes     String?         // Provider's private notes
  
  // Cancellation
  cancelledAt       DateTime?
  cancelledBy       String?         // userId
  cancellationReason String?
  
  // Completion
  completedAt       DateTime?
  
  // Relations
  homeowner         User              @relation("BookingHomeowner", fields: [homeownerId], references: [id])
  provider          User              @relation("BookingProvider", fields: [providerId], references: [id])
  providerProfile   ProviderProfile   @relation(fields: [providerProfileId], references: [id])
  property          Property          @relation(fields: [propertyId], references: [id])
  service           Service           @relation(fields: [serviceId], references: [id])
  payments          Payment[]
  documents         Document[]
  messages          Message[]
  review            Review?
  timeline          BookingTimeline[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([category])
  @@map("bookings")
}

model BookingTimeline {
  id        String   @id @default(uuid())
  bookingId String
  
  status    BookingStatus
  note      String?
  createdBy String?  // userId
  
  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([bookingId])
  @@map("booking_timeline")
}

// ============================================================================
// PAYMENT MANAGEMENT
// ============================================================================

model Payment {
  id          String        @id @default(uuid())
  bookingId   String
  
  // Payment Details
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("USD")
  status      PaymentStatus @default(PENDING)
  
  // Payment Type
  isDeposit   Boolean       @default(false)
  
  // Stripe
  stripePaymentIntentId String? @unique
  stripeChargeId        String? @unique
  
  // Metadata
  description String?
  failureReason String?
  
  // Refund
  refundedAmount Decimal? @db.Decimal(10, 2)
  refundedAt     DateTime?
  
  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([bookingId])
  @@index([status])
  @@map("payments")
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model Document {
  id          String       @id @default(uuid())
  bookingId   String?
  uploadedBy  String       // userId
  
  // Document Details
  type        DocumentType
  name        String
  description String?
  fileUrl     String
  fileSize    Int          // Bytes
  mimeType    String
  
  // Metadata
  metadata    Json? // Flexible storage for document-specific data
  
  // Relations
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([bookingId])
  @@index([type])
  @@map("documents")
}

// ============================================================================
// MESSAGING SYSTEM
// ============================================================================

model Message {
  id          String      @id @default(uuid())
  bookingId   String?
  senderId    String
  recipientId String
  
  // Message Content
  type        MessageType @default(TEXT)
  content     String
  attachments Json? // Array of file URLs
  
  // Status
  isRead      Boolean     @default(false)
  readAt      DateTime?
  
  // Relations
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([bookingId])
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
  @@map("messages")
}

// Add new enum for frequency
enum RecurrenceFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
}


model MaintenanceTaskTemplate {
  id               String               @id @default(uuid())
  title            String
  description      String?
  defaultFrequency RecurrenceFrequency
  serviceCategory  ServiceCategory?
  
  // NEW fields
  isActive         Boolean @default(true)
  sortOrder        Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("maintenance_task_templates")
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id          String       @id @default(uuid())
  bookingId   String       @unique
  authorId    String
  providerId  String
  
  // Rating (1-5)
  rating      Int
  
  // Review Content
  title       String?
  content     String
  
  // Review Categories (1-5 each)
  qualityRating      Int?
  communicationRating Int?
  valueRating        Int?
  professionalismRating Int?
  
  // Moderation
  status      ReviewStatus @default(PENDING)
  moderatedAt DateTime?
  moderatedBy String? // admin userId
  
  // Provider Response
  response    String?
  respondedAt DateTime?
  
  // Relations
  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  author   User    @relation("ReviewAuthor", fields: [authorId], references: [id])
  provider User    @relation("ReviewProvider", fields: [providerId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerId])
  @@index([rating])
  @@index([status])
  @@map("reviews")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id       String  @id @default(uuid())
  userId   String
  
  // Notification Details
  type     String  // booking_confirmed, payment_received, etc.
  title    String
  message  String
  
  // Action
  actionUrl String?
  
  // Status
  isRead   Boolean @default(false)
  readAt   DateTime?
  
  // Metadata
  metadata Json?
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// FAVORITES
// ============================================================================

model Favorite {
  id                String   @id @default(uuid())
  userId            String
  providerProfileId String
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, providerProfileId])
  @@index([userId])
  @@map("favorites")
}

// ============================================================================
// SYSTEM TABLES
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  
  // Who & What
  userId     String?
  action     String   // created_booking, updated_payment, etc.
  entityType String   // booking, payment, user, etc.
  entityId   String
  
  // Changes
  oldValues  Json?
  newValues  Json?
  
  // Context
  ipAddress  String?
  userAgent  String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json
  
  description String?
  updatedAt DateTime @updatedAt
  
  @@map("system_settings")
}