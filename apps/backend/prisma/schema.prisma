// Contract to Cozy - Database Schema
// Inspection + Handyman Categories
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  HOMEOWNER
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

// NEW ENUM to track the homeowner's current goal/state
enum HomeownerSegment {
  HOME_BUYER       // Actively in the closing process
  EXISTING_OWNER   // Standard homeowner focused on maintenance
}

enum ChecklistItemStatus {
  PENDING
  COMPLETED
  NOT_NEEDED
}

// ADDED 
// ENUMS FOR PROPERTY DETAILS (Phase 1)
enum PropertyType {
  SINGLE_FAMILY
  TOWNHOME
  CONDO
  APARTMENT
  MULTI_UNIT
  INVESTMENT_PROPERTY
}

enum OwnershipType {
  OWNER_OCCUPIED
  RENTED_OUT
}

enum HeatingType {
  HVAC
  FURNACE
  HEAT_PUMP
  RADIATORS
  UNKNOWN
}

enum CoolingType {
  CENTRAL_AC
  WINDOW_AC
  UNKNOWN
}

enum WaterHeaterType {
  TANK
  TANKLESS
  HEAT_PUMP
  SOLAR
  UNKNOWN
}

enum RoofType {
  SHINGLE
  TILE
  FLAT
  METAL
  UNKNOWN
}

// ============================================================================
// NEW ENUMS FOR RISK ASSESSMENT (PHASE 1)
// ============================================================================

enum RiskCategory {
  STRUCTURE
  SYSTEMS
  SAFETY
  FINANCIAL_GAP // Used to categorize non-physical risks like insurance shortfalls
}

// ============================================================================
// NEW ENUM: WARRANTY CATEGORIES
// This replaces any concept of a "General" or "Whole Property" category.
// ============================================================================
enum WarrantyCategory {
  APPLIANCE
  HVAC
  ROOFING
  PLUMBING
  ELECTRICAL
  STRUCTURAL
  HOME_WARRANTY_PLAN // Explicitly for multi-system coverage (e.g., a service contract)
  OTHER
}

enum LocalUpdateCategory {
  INTERNET
  INSURANCE
  MAINTENANCE
  ENERGY
}

enum LocalUpdateEventType {
  IMPRESSION
  CLICK
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
}

enum ClimateRegion {
  VERY_COLD
  COLD
  MODERATE
  WARM
  TROPICAL
}

enum SeasonalChecklistStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DISMISSED
}

enum SeasonalTaskStatus {
  RECOMMENDED
  ADDED
  COMPLETED
  DISMISSED
  SNOOZED
}

enum TaskPriority {
  CRITICAL
  RECOMMENDED
  OPTIONAL
}

// ============================================================================
// PHASE 1: NEW ENUMS FOR CHECKLIST SPLIT
// ============================================================================

enum HomeBuyerTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  NOT_NEEDED
}

enum MaintenanceTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NEEDS_REVIEW
}

enum MaintenanceTaskSource {
  USER_CREATED
  ACTION_CENTER
  SEASONAL
  RISK_ASSESSMENT
  WARRANTY_RENEWAL
  TEMPLATE
  RECALL_ALERT 
}

enum MaintenanceTaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RiskLevel {
  LOW
  MODERATE
  ELEVATED
  HIGH
  CRITICAL
}

enum NotificationTiming {
  EARLY
  STANDARD
  LATE
}


enum InventoryItemCategory {
  APPLIANCE
  HVAC
  PLUMBING
  ELECTRICAL
  ROOF_EXTERIOR
  SAFETY
  SMART_HOME
  FURNITURE
  ELECTRONICS
  OTHER
}

enum InventoryItemCondition {
  NEW
  GOOD
  FAIR
  POOR
  UNKNOWN
}

enum InventoryItemSource {
  MANUAL
  BULK_UPLOAD
  MOBILE_SCAN
  INTEGRATION
}

enum ImportBatchStatus {
  COMPLETED
  PARTIAL
  FAILED
  ROLLED_BACK
}

enum InventoryDraftSource {
  OCR_LABEL
  ROOM_PHOTO_AI
  ROOM_VIDEO_AI
}

model InventoryRoomScanSession {
  id          String   @id @default(uuid())
  propertyId  String
  roomId      String
  userId      String

  status      String   @default("PROCESSING") // PROCESSING | COMPLETE | FAILED
  provider    String?  // e.g. "openai", "gemini", "stub"

  // S3 keys for raw uploads (optional)
  imageKeys   Json?
  // raw provider output for debugging (optional)
  resultJson  Json?
  error       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime?

  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  room        InventoryRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  scanSessions   InventoryRoomScanSession[]

  inventoryDrafts InventoryDraftItem[] @relation("SessionInventoryDrafts")
  drafts          InventoryDraftItem[] @relation("SessionDrafts")

  @@index([propertyId, createdAt])
  @@index([userId, createdAt])
  @@index([roomId, createdAt])
}

model InventoryImportBatch {
  id              String   @id @default(uuid())
  propertyId       String
  createdByUserId  String?
  fileName         String?
  templateVersion  Int      @default(1)

  status           ImportBatchStatus @default(COMPLETED)

  createdCount     Int      @default(0)
  skippedCount     Int      @default(0)
  errorCount       Int      @default(0)

  notes            String?
  meta             Json?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  property         Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy        User?    @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  items            InventoryItem[]

  @@index([propertyId, createdAt])
  @@map("inventory_import_batches")
}


model InventoryRoom {
  id         String   @id @default(uuid())
  propertyId String

  name       String
  floorLevel Int?
  sortOrder  Int      @default(0)

  // âœ… NEW
  type       RoomType?  @default(OTHER)
  profile    Json?      // optional questionnaire / notes for this room (lightweight)
  heroImage  String?    // optional (can be null); URL if you ever add visuals

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property   Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items      InventoryItem[]
  checklistItems RoomChecklistItem[]
  maintenanceTasks PropertyMaintenanceTask[]
  incidents        Incident[]
  homeEvents HomeEvent[]

  @@index([propertyId])
  @@unique([propertyId, name])
  @@map("inventory_rooms")
}

model InventoryItem {
  id          String   @id @default(uuid())
  propertyId  String
  roomId      String?

  // Source tracking (future proof)
  sourceType      InventoryItemSource @default(MANUAL)
  sourceBatchId   String?
  sourceRowNumber Int?
  sourceHash      String?
  sourceFileName  String?
  importedAt      DateTime?

  // Optional mapping to your existing "system asset" model
  homeAssetId String?

  // Optional linkage to existing coverage models
  warrantyId        String?
  insurancePolicyId String?

  // Core fields
  name       String
  category   InventoryItemCategory  @default(OTHER)
  condition  InventoryItemCondition @default(UNKNOWN)

  // Optional identity fields
  brand      String?
  model      String?
  serialNo   String?

  // Dates
  installedOn     DateTime?
  purchasedOn     DateTime?
  lastServicedOn  DateTime?

  // Costs (use Int cents for consistency; your schema also uses Decimal in places)
  purchaseCostCents     Int?
  replacementCostCents  Int?
  currency              String @default("USD")

  // Notes + tags
  notes     String?
  tags      String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  property        Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  room            InventoryRoom?  @relation(fields: [roomId], references: [id], onDelete: SetNull)
  homeAsset       HomeAsset?      @relation(fields: [homeAssetId], references: [id], onDelete: SetNull)
  warranty        Warranty?       @relation(fields: [warrantyId], references: [id], onDelete: SetNull)
  linkedWarranties Warranty[]     @relation("WarrantyToInventoryItem")
  insurancePolicy InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id], onDelete: SetNull)
  importBatch   InventoryImportBatch? @relation(fields: [sourceBatchId], references: [id], onDelete: SetNull)


  // Reuse your existing Document table for receipts/photos/manuals
  documents        Document[]
  insuranceQuoteRequests InsuranceQuoteRequest[]
  homeEvents HomeEvent[]

  // Recall matching fields (NEW)
  manufacturer   String?
  modelNumber    String?
  serialNumber   String?
  upc            String?
  sku            String?

  // Optional normalized versions to improve matching & indexing
  manufacturerNorm String?
  modelNumberNorm  String?

  // relations (NEW)
  recallMatches  RecallMatch[]

  @@index([manufacturerNorm, modelNumberNorm])
  @@index([upc])

  @@index([propertyId])
  @@index([roomId])
  @@index([homeAssetId])
  @@index([warrantyId])
  @@index([insurancePolicyId])

  // Filter-friendly composite indexes
  @@index([propertyId, category])
  @@index([propertyId, roomId])
  @@index([propertyId, sourceBatchId])

  @@unique([propertyId, sourceHash])

  @@map("inventory_items")
}

enum QuoteRequestStatus {
  NEW
  SUBMITTED
  IN_PROGRESS
  CLOSED
}

enum QuoteRequestSource {
  COVERAGE_GAP
  MANUAL
}

model InsuranceQuoteRequest {
  id                 String   @id @default(uuid())
  homeownerProfileId String
  propertyId         String
  inventoryItemId    String?

  // Context
  source             QuoteRequestSource @default(COVERAGE_GAP)
  gapType            String?
  exposureCents      Int?
  currency           String   @default("USD")

  // User input
  preferredContact   String?  // "EMAIL" | "SMS" | "PHONE" (keep string to avoid churn)
  contactEmail       String?
  contactPhone       String?
  zipCode            String?
  notes              String?

  status             QuoteRequestStatus @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homeownerProfile HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  property         Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  inventoryItem    InventoryItem?   @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)

  @@index([homeownerProfileId])
  @@index([propertyId])
  @@index([status])
  @@map("insurance_quote_requests")
}


// NEW: Service 
// category configuration for segment targeting
model ServiceCategoryConfig {
  id            String          @id @default(uuid())
  category      ServiceCategory @unique
  
  // Segment targeting
  availableForHomeBuyer     Boolean @default(true)
  availableForExistingOwner Boolean @default(true)
  
  // Display properties
  displayName   String
  description   String?
  icon          String? // Icon identifier for frontend
  sortOrder     Int    @default(0)
  
  // Status
  isActive      Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category])
  @@map("service_category_config")
}

// ============================================================================
// RISK ASSESSMENT MANAGEMENT (PHASE 1)
// ============================================================================

// 1. New Model: SystemComponentConfig
// Stores the static configuration data (lifespan, cost) used for the risk calculation.
model SystemComponentConfig {
  id                String         @id @default(uuid())
  systemType        String         @unique // e.g., 'HVAC_FURNACE', 'ROOF_SHINGLE'
  category          RiskCategory   
  
  // Financial Data
  expectedLife      Int            // Years
  replacementCost   Decimal        @db.Decimal(12, 2)
  
  // Warning Flags: Allows configuration of point-based penalties
  warningFlags      Json? // e.g., { "hasDrainageIssues": 0.2 }
  
  // Status
  isActive          Boolean        @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_component_configs")
}

// 2. New Model: RiskAssessmentReport
// Caches the calculated risk score and detailed breakdown for a property.
model RiskAssessmentReport {
  id                       String    @id @default(uuid())
  propertyId               String    @unique // MUST be unique for a 1:1 relation
  
  // Calculated Scores (Phase 2 output)
  riskScore                Float     // 0.0 to 100.0
  financialExposureTotal   Decimal   @db.Decimal(12, 2) // Total Risk Dollar Exposure
  details                  Json      
  
  // Relations: ***FIX APPLIED: Added @relation(name: "PropertyRiskReport")***
  property                 Property  @relation(name: "PropertyRiskReport", fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  lastCalculatedAt DateTime @updatedAt 
  createdAt DateTime @default(now())
  
  @@map("risk_assessment_reports")
}

// ============================================================================
// INVENTORY SCANNER
// ============================================================================

enum InventoryOcrSessionStatus {
  COMPLETE
  FAILED
  EXPIRED
}

enum InventoryDraftStatus {
  DRAFT
  CONFIRMED
  DISMISSED
}

model InventoryOcrSession {
  id          String   @id @default(uuid())
  propertyId  String
  userId      String

  status      InventoryOcrSessionStatus @default(COMPLETE)

  provider    String?  // e.g. "tesseract"
  rawText     String?  // full OCR text (no image stored)
  error       String?

  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fields      InventoryOcrField[]
  drafts      InventoryDraftItem[]

  @@index([propertyId])
  @@index([userId])
  @@index([createdAt])
}

model InventoryOcrField {
  id          String   @id @default(uuid())
  sessionId   String

  key         String   // "manufacturer" | "modelNumber" | "serialNumber" | etc
  value       String
  confidence  Float    // 0..1

  createdAt   DateTime @default(now())

  session     InventoryOcrSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([key])
}

model InventoryDraftItem {
  id          String   @id @default(uuid())
  propertyId  String
  userId      String
  sessionId   String?

  status      InventoryDraftStatus @default(DRAFT)

  // extracted / editable fields
  name         String?
  category     InventoryItemCategory?
  condition    InventoryItemCondition?

  brand        String?
  model        String?
  serialNo     String?

  manufacturer String?
  modelNumber  String?
  serialNumber String?
  upc          String?
  sku          String?

  // confidence snapshot for UI (field->confidence)
  confidenceJson Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     InventoryOcrSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  roomId        String?
  scanSessionId String?
  draftSource   InventoryDraftSource @default(OCR_LABEL)

  scanSession   InventoryRoomScanSession? @relation(fields: [scanSessionId], references: [id], onDelete: SetNull)
  room          InventoryRoom?            @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@index([scanSessionId])
  @@index([roomId, status])

  @@index([propertyId, status])
  @@index([userId, status])
  @@index([createdAt])
}


// ============================================================================
// FINANCIAL EFFICIENCY MANAGEMENT (PHASE 2)
// ============================================================================

// 1.1 New Model: FinancialEfficiencyConfig (Benchmark Data)
// Stores the static configuration data (market averages) used for FES calculation.
model FinancialEfficiencyConfig {
  id                      String          @id @default(uuid())
  
  // Targeting fields to match a property
  zipCode                 String?
  propertyType            PropertyType?  // Uses existing enum
  
  // Benchmark Values (Annualized)
  avgInsurancePremium     Decimal         @db.Decimal(12, 2)
  avgUtilityCost          Decimal         @db.Decimal(12, 2) 
  avgWarrantyCost         Decimal         @db.Decimal(12, 2)
  
  // Optional: Allows benchmarks to be set per sqft if data supports it
  unitOfMeasure           String          @default("ANNUAL") 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Ensures a combination of zipCode and propertyType is unique for a benchmark
  @@unique([zipCode, propertyType])
  @@map("financial_efficiency_configs")
}

// 1.2 New Model: FinancialEfficiencyReport (Report Cache)
// Caches the calculated FES and detailed breakdown for a property.
model FinancialEfficiencyReport {
  id                        String    @id @default(uuid())
  propertyId                String    @unique // MUST be unique for a 1:1 relation
  
  // Calculated Score
  financialEfficiencyScore  Float     // 0.0 to 100.0+
  
  // Component Breakdown for transparency (Actual Costs vs Market Averages)
  actualInsuranceCost       Decimal   @db.Decimal(12, 2)
  actualUtilityCost         Decimal   @db.Decimal(12, 2)
  actualWarrantyCost        Decimal   @db.Decimal(12, 2)
  marketAverageTotal        Decimal   @db.Decimal(12, 2) 
  
  // Relation: Links back to the Property
  property                  Property  @relation(name: "PropertyFinancialReport", fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  lastCalculatedAt DateTime @updatedAt 
  createdAt DateTime @default(now())
  
  @@map("financial_efficiency_reports")
}


enum ServiceCategory {
  INSPECTION    
  // HOME_BUYER primary
  HANDYMAN           // Both segments
  PLUMBING           // EXISTING_OWNER primary
  ELECTRICAL       
  // EXISTING_OWNER primary
  HVAC               // Both segments
  LANDSCAPING        // EXISTING_OWNER primary
  CLEANING           // Both segments (move-in for 
  // buyers, maintenance for owners)
  MOVING             // HOME_BUYER primary
  PEST_CONTROL       // Both segments
  LOCKSMITH          // Both segments
  
  INSURANCE
  ATTORNEY
  FINANCE            // EXISTING_OWNER - Property tax renewals
  WARRANTY           // EXISTING_OWNER - Warranty renewals
  ADMIN           
  // EXISTING_OWNER - Administrative reminders
}

enum InspectionType {
  HOME_INSPECTION
  PEST_INSPECTION
  RADON_TESTING
  MOLD_INSPECTION
  WELL_SEPTIC_INSPECTION
  ROOF_INSPECTION
  FOUNDATION_INSPECTION
  ELECTRICAL_INSPECTION
  PLUMBING_INSPECTION
}

enum HandymanType {
  MINOR_REPAIRS
  FIXTURE_INSTALLATION
  FURNITURE_ASSEMBLY
  DRYWALL_REPAIR
  DOOR_WINDOW_REPAIR
  DECK_FENCE_REPAIR
  GENERAL_MAINTENANCE
  PAINTING_TOUCHUP
  CAULKING_SEALING
}

enum BookingStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  FAILED
  CANCELLED
}

enum DocumentType {
  INSPECTION_REPORT
  ESTIMATE
  INVOICE
  CONTRACT
  PERMIT
  PHOTO
  VIDEO
  INSURANCE_CERTIFICATE
  LICENSE
  HOME_REPORT_PDF
  OTHER
}

enum MessageType {
  TEXT
  SYSTEM
  BOOKING_UPDATE
  PAYMENT_UPDATE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum ProviderStatus {
  PENDING_APPROVAL
  ACTIVE
  INACTIVE
  SUSPENDED
}

// NEW ENUM for tracking different types of homeowner expenses
enum ExpenseCategory {
  REPAIR_SERVICE
  PROPERTY_TAX
  HOA_FEE
  UTILITY
 
  APPLIANCE
  MATERIALS
  OTHER
}

// ============================================================================
// USER MANAGEMENT
// ============================================================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  phone     String?
  firstName String
  lastName  String
  role      UserRole   @default(HOMEOWNER)
  status    UserStatus @default(ACTIVE)
  
  // Authentication
  passwordHash String
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)
  
  // Profile
  avatar       String?
  bio          String?
  address      Address?
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  homeownerProfile HomeownerProfile?
  providerProfile  ProviderProfile?
  bookings         Booking[]        @relation("BookingHomeowner")
  providerBookings Booking[]        @relation("BookingProvider")
  reviews          Review[]         @relation("ReviewAuthor")
  receivedReviews  Review[]         @relation("ReviewProvider")
  messages         Message[]
  notifications    Notification[]
  favorites        Favorite[]
  homeReportExports HomeReportExport[]
  claimsCreated        Claim[]
  claimTimelineEvents  ClaimTimelineEvent[]
  inventoryImportBatches InventoryImportBatch[]

  inventoryOcrSessions InventoryOcrSession[]
  inventoryDraftItems  InventoryDraftItem[]
  inventoryRoomScanSessions InventoryRoomScanSession[]
  homeEvents HomeEvent[]
  
  @@index([email])
  @@index([role])
  
  @@index([status])
  @@map("users")
}

model Address {
  id      String  @id @default(uuid())
  userId  String  @unique
  
  // Address components
  street1     String
  street2     String?
  city        String
  state       String
  zipCode     String
  country     String @default("USA")
  
  // Geocoding
  latitude    Float?
  longitude   Float?
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([zipCode])
  @@index([city, state])
  @@map("addresses")
}

// ============================================================================
// HOMEOWNER PROFILE
// ============================================================================

model HomeownerProfile {
  id     String @id @default(uuid())
  userId String @unique

  // NEW FIELD to identify the user's segment.
  // Defaults to EXISTING_OWNER for 100% backward compatibility.
  segment HomeownerSegment @default(EXISTING_OWNER)

  // Purchase Information (for HOME_BUYER segment)
  closingDate         DateTime?
  purchasePrice       Decimal?  @db.Decimal(12, 2)

  // Preferences
  preferredContactMethod String?
  // email, phone, text
  notificationPreferences Json?  // Flexible JSON for various notification settings

  // Budget tracking
  totalBudget         Decimal? @db.Decimal(12, 2)
  spentAmount         Decimal   @default(0) @db.Decimal(12, 2)

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties  Property[]
  checklist   Checklist?
  
  // PHASE 1: NEW RELATION
  homeBuyerChecklist HomeBuyerChecklist?
  
  // NEW RELATIONS
  warranties  Warranty[]
  insurancePolicies InsurancePolicy[]
  expenses    Expense[]
  insuranceQuoteRequests InsuranceQuoteRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("homeowner_profiles")
}

// ============================================================================
// HOME BUYER CHECKLIST
// ============================================================================

model Checklist {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homeownerProfileId String           @unique
  homeownerProfile   HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)

  items ChecklistItem[]

  @@map("checklists")
}


// Update ChecklistItem model - add these fields:
model ChecklistItem {
  id     String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?
  status      ChecklistItemStatus @default(PENDING)
  
  serviceCategory String?
  actionKey String?
  orchestrationActionId String?
  
  isRecurring        Boolean   @default(false)
  frequency          RecurrenceFrequency?
  nextDueDate        DateTime?
  lastCompletedDate  DateTime?
  checklistId        String
  propertyId         String?

  seasonalChecklistItemId  String?    @map("seasonal_checklist_item_id")
  isSeasonal               Boolean    @default(false) @map("is_seasonal")
  season                   Season?
  seasonalChecklistItem    SeasonalChecklistItem?   @relation
  
  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  
  sortOrder   Int @default(0)

  @@index([checklistId])
  @@index([actionKey])
  @@unique([propertyId, actionKey])
  @@unique([propertyId, orchestrationActionId])
  @@index([isSeasonal, season])
  
  @@map("checklist_items")
}

// ============================================================================
// PHASE 1: NEW MODELS - HOME BUYER CHECKLIST SYSTEM
// ============================================================================

model HomeBuyerChecklist {
  id String @id @default(uuid())
  
  // User-scoped (NOT property-scoped)
  homeownerProfileId String @unique
  homeownerProfile HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  
  // Relations
  tasks HomeBuyerTask[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("home_buyer_checklists")
}

model HomeBuyerTask {
  id String @id @default(uuid())
  checklistId String
  
  // Task details
  title String
  description String?
  status HomeBuyerTaskStatus @default(PENDING)
  
  // Service integration
  serviceCategory ServiceCategory?
  
  // Booking integration
  bookingId String? @unique
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  // Completion tracking
  completedAt DateTime?
  
  // Display
  sortOrder Int @default(0)
  
  // Relations
  checklist HomeBuyerChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([checklistId])
  @@index([status])
  @@map("home_buyer_tasks")
}

// ============================================================================
// PHASE 1: NEW MODELS - PROPERTY MAINTENANCE SYSTEM
// ============================================================================

model PropertyMaintenanceTask {
  id String @id @default(uuid())
  propertyId String
  
  // Task details
  title String
  description String?
  status MaintenanceTaskStatus @default(PENDING)
  
  // Source tracking (WHO created this?)
  source MaintenanceTaskSource
  actionKey String? // Format: "propertyId:SOURCE:assetType"
  
  // Priority & Risk
  priority MaintenanceTaskPriority @default(MEDIUM)
  riskLevel RiskLevel?
  
  // Asset tracking (WHAT is this for?)
  assetType String? // Links to risk assessment
  category String? // System category (HVAC, Plumbing, etc.)
  
  // Service integration
  serviceCategory ServiceCategory?
  
  // Recurring tasks
  isRecurring Boolean @default(false)
  frequency RecurrenceFrequency?
  nextDueDate DateTime?
  lastCompletedDate DateTime?
  
  // Cost tracking
  estimatedCost Decimal? @db.Decimal(10, 2)
  actualCost Decimal? @db.Decimal(10, 2)
  
  // Seasonal integration
  isSeasonal Boolean @default(false)
  season Season?
  seasonalChecklistItemId String? @unique
  seasonalChecklistItem SeasonalChecklistItem? @relation(fields: [seasonalChecklistItemId], references: [id], onDelete: SetNull)
  
  // Booking integration
  bookingId String? @unique
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  // Enhanced relationships
  warrantyId String?
  warranty Warranty? @relation(fields: [warrantyId], references: [id], onDelete: SetNull)
  
  homeAssetId String?
  homeAsset HomeAsset? @relation(fields: [homeAssetId], references: [id], onDelete: SetNull)
  
  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  recallMatchId String? @unique
  recallMatch   RecallMatch?

  roomId String?
  room   InventoryRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomId]) 
  @@index([recallMatchId])
  @@unique([propertyId, actionKey])
  @@index([propertyId])
  @@index([status])
  @@index([priority])
  @@index([source])
  @@index([nextDueDate])
  @@index([assetType])
  @@map("property_maintenance_tasks")
}

model Property {
  id                 String   @id @default(uuid())
  homeownerProfileId String
  
  // Address Details (Existing Fields)
  name         String? // e.g., "Main Home", "Investment Property"
  address     String
  city        String
  state       String
  zipCode     String
  
  isPrimary   Boolean  @default(true)
  
  // ============================================================================
  // NEW PROPERTY DETAILS (FROM HOMEOWNERPROFILE & NEW REQUIREMENTS) - PHASE 1 ADDITIONS
  // ============================================================================
  
  // Migrated from HomeownerProfile (Layer 1 - Basic)
  propertyType        PropertyType?
  propertySize        Int?    // Square footage
  yearBuilt           Int?
  // Migrated from HomeownerProfile (Layer 2 - Advanced)
  bedrooms            Int?
  bathrooms           Float?
  // New Basic/Advanced Fields
  ownershipType       OwnershipType?
  occupantsCount      Int? // Number of Occupants (Layer 2 - Usage/Wear Factor)
  
  // New Systems Snapshot (Layer 2 - Systems Factor)
  heatingType         HeatingType?
  coolingType         CoolingType?
  waterHeaterType     WaterHeaterType?
  // New Structure Snapshot (Layer 2 - Structure Factor)
  roofType            RoofType?
  // New Optional Fields (Layer 2 - Extra Score Details)
  hvacInstallYear     Int?
  waterHeaterInstallYear Int?
  roofReplacementYear Int?
  foundationType      String?
  sidingType          String?
  electricalPanelAge  Int?
  
  // Exterior & Utilities
  lotSize             Float?
  hasIrrigation       Boolean?
  hasDrainageIssues   Boolean?
  
  // Safety
  hasSmokeDetectors   Boolean?
  hasCoDetectors      Boolean?
  hasSecuritySystem   Boolean?
  hasFireExtinguisher Boolean?
  // Appliances
  homeAssets          HomeAsset[]
  movingPlans         MovingPlan[]  // Add this line

  // ============================================================================
  // END NEW PROPERTY DETAILS
  // ============================================================================
  
  // Relations
  homeownerProfile HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  bookings         Booking[]

  // NEW RELATIONS
  warranties       Warranty[]
  insurancePolicies InsurancePolicy[]
  expenses         Expense[]
  checklistItems   ChecklistItem[]
  
  // PHASE 1: NEW RELATION
  maintenanceTasks PropertyMaintenanceTask[]
 
  documents        Document[]


  // NEW RELATION FOR RISK ASSESSMENT (Phase 1): ***FIX APPLIED: Added @relation(name: "PropertyRiskReport")***
  riskReport       RiskAssessmentReport? @relation(name: "PropertyRiskReport")
  
  // 1.3 NEW RELATION FOR FINANCIAL EFFICIENCY (Phase 2):
  financialReport  FinancialEfficiencyReport? @relation(name: "PropertyFinancialReport")
  inspectionReports   InspectionReport[]

  seasonalChecklists       SeasonalChecklist[]
  seasonalChecklistItems   SeasonalChecklistItem[]
  climateSetting           PropertyClimateSetting?

  inventoryRooms InventoryRoom[]
  inventoryItems InventoryItem[]
  insuranceQuoteRequests InsuranceQuoteRequest[]
  homeReportExports HomeReportExport[]

  claims Claim[]
  claimTimelineEvents ClaimTimelineEvent[]
  recallMatches      RecallMatch[]
  incidents          Incident[]
  inventoryImportBatches InventoryImportBatch[]

  inventoryOcrSessions InventoryOcrSession[]
  inventoryDraftItems  InventoryDraftItem[]
  roomChecklistItems RoomChecklistItem[]
  homeEvents HomeEvent[]
  financeSnapshots  PropertyFinanceSnapshot[]
  toolOverrides     ToolOverride[]

  roomScanSessions      InventoryRoomScanSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerProfileId])
  @@map("properties")
}

// ============================================================================
// PROVIDER PROFILE
// ============================================================================

model ProviderProfile {
  id     String @id @default(uuid())
  userId String @unique
  
  // Business Information
  businessName        String
  businessType        String? // LLC, Sole Proprietor, Corporation
  taxId               String? // Service Information
  serviceCategories   ServiceCategory[]
  serviceRadius       Int      @default(25)  // Miles
  
  // Verification
  status              ProviderStatus @default(PENDING_APPROVAL)
  backgroundCheckDate DateTime?
  insuranceVerified   Boolean        @default(false)
  licenseVerified     Boolean        @default(false)
  
  // Business Details
  yearsInBusiness     Int?
  teamSize            Int?
  description         String?
  website             String?
  // Ratings
  averageRating       Float    @default(0) @db.Real
  totalReviews        Int      @default(0)
  totalCompletedJobs  Int      @default(0)
  
  // Availability
  availabilitySchedule Json? // Weekly schedule
  
  // Stripe Connect
  stripeAccountId     String? @unique
  stripeOnboarded     Boolean  @default(false)
  
  // Relations
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  services           Service[]
  certifications     Certification[]
  portfolioImages    ProviderPortfolio[]
  bookings           Booking[]
  availability       ProviderAvailability[]

  // FIX: ADD THE INVERSE RELATION FIELD
  favorites          Favorite[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([status])
  @@index([userId])
  @@map("provider_profiles")
}

model Certification {
  id                String   @id @default(uuid())
  providerProfileId String
  
  name              String
  issuingAuthority  String
  certificateNumber String?
  issueDate         DateTime
  expiryDate        DateTime?
  documentUrl       String?
  verified          Boolean  @default(false)
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@map("certifications")
}

model ProviderPortfolio {
  id                String  @id @default(uuid())
  providerProfileId String
  
  title             String
  description       String?
  imageUrl          String
  category          ServiceCategory
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([providerProfileId])
  @@map("provider_portfolio")
}

model ProviderAvailability {
  id                String   @id @default(uuid())
  providerProfileId String
  
  // Date range
  startDate         DateTime
  endDate           DateTime
  isAvailable       Boolean  @default(true)
  reason            String? // vacation, booked, etc.
  
  // Relations
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@index([startDate, endDate])
  @@map("provider_availability")
}

// ============================================================================
// SERVICES
// ============================================================================

model Service {
  id                String          @id @default(uuid())
  providerProfileId String
  
  // Service Details
  category          ServiceCategory
  inspectionType    InspectionType?
  handymanType      HandymanType?
  
  name              String
  description       String
  
  // Pricing
  basePrice         Decimal         @db.Decimal(10, 2)
  priceUnit         String          // "per hour", "per sqft", "flat rate"
  minimumCharge     Decimal? @db.Decimal(10, 2)
  
  // Availability
  isActive          Boolean         @default(true)
  estimatedDuration Int? // Minutes
  
  // Relations
  providerProfile   ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerProfileId])
  @@index([category])
  @@index([isActive])
  @@map("services")
}

// ============================================================================
// BOOKING MANAGEMENT
// ============================================================================

model Booking {
  id                String        @id @default(uuid())
  bookingNumber     String        @unique // B-2025-001234
 
  
  // Parties
  homeownerId       String
  providerId        String
  providerProfileId String
  propertyId        String
  serviceId         String
  
  // Booking Details
  category          ServiceCategory
  status            BookingStatus   @default(PENDING)
  
  // Scheduling
  requestedDate     DateTime?
  scheduledDate     DateTime?
  startTime         DateTime?
  endTime           DateTime?
  actualStartTime   DateTime?
  actualEndTime     DateTime?
  
  // Pricing
  estimatedPrice    Decimal         @db.Decimal(10, 2)
  finalPrice        Decimal? @db.Decimal(10, 2)
  depositAmount     Decimal?        @db.Decimal(10, 2)
  
  // Details
  description       String
  specialRequests   String?
  internalNotes     String?         // Provider's private notes
  
  // Cancellation
  cancelledAt       DateTime?
  cancelledBy       String?         // userId
  cancellationReason String?
  // Completion
  completedAt       DateTime?
  
  // PHASE 1: NEW RELATIONS - Task Integration
  homeBuyerTaskId String? @unique
  homeBuyerTask HomeBuyerTask?
  
  propertyMaintenanceTaskId String? @unique
  propertyMaintenanceTask PropertyMaintenanceTask?
  
  // Relations
  homeowner         User              @relation("BookingHomeowner", fields: [homeownerId], references: [id])
  provider          User              @relation("BookingProvider", fields: [providerId], references: [id])
  providerProfile   ProviderProfile   @relation(fields: [providerProfileId], references: [id])
  property          Property          @relation(fields: [propertyId], references: [id])
  service           Service           @relation(fields: [serviceId], references: [id])
  payments          Payment[]
  documents         Document[]
  messages          Message[]
  review            Review?
  timeline          BookingTimeline[]
  expenses          Expense[] // NEW: Expense link
  insightFactor     String?  // "Age Factor", "Roof Age", etc.
  insightContext    String?  // Optional additional context
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([category])
  @@map("bookings")
  @@index([insightFactor])  // For fast lookups
}

model BookingTimeline {
  id        String   @id @default(uuid())
  bookingId String
  
  status    BookingStatus
  note      String?
  createdBy String?  // userId
  
  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([bookingId])
  @@map("booking_timeline")
}

// ============================================================================
// PAYMENT MANAGEMENT
// ============================================================================

model Payment {
  id          String        @id @default(uuid())
  bookingId   String
  
  // Payment Details
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("USD")
  status      PaymentStatus @default(PENDING)
  
  // Payment Type
  isDeposit   Boolean       @default(false)
  
  // Stripe
  stripePaymentIntentId String? @unique
  stripeChargeId        String? @unique
  
  // Metadata
  description String?
  failureReason String?
  
  // Refund
  refundedAmount Decimal? @db.Decimal(10, 2)
  refundedAt     DateTime?
  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([bookingId])
  @@index([status])
  @@map("payments")
}

// ============================================================================
// DOCUMENT MANAGEMENT
// ============================================================================

model Document {
  id          String       @id @default(uuid())
  bookingId   String?
  propertyId  String?      // NEW: Link to general home documents
  warrantyId  String? // NEW: Link to a Warranty record
  policyId    String? // NEW: Link to an InsurancePolicy record

  uploadedBy  String       // userId
  
  // Document Details
  type        DocumentType
  name        String
  description String?
  fileUrl     String
  fileSize    Int          // Bytes
  mimeType    String
  
  // Metadata
  metadata    Json? // Flexible storage for document-specific data
  
  // Relations
  booking          Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  property         Property? @relation(fields: [propertyId], references: [id])
  warranty         Warranty? @relation(fields: [warrantyId], references: [id], onDelete: Cascade)
  insurancePolicy  InsurancePolicy? @relation(fields: [policyId], references: [id], onDelete: Cascade)
  inventoryItemId  String? // NEW: Link to an InventoryItem record
  inventoryItem    InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  homeReportExports HomeReportExport[]
  claimDocuments ClaimDocument[]
  homeEventLinks HomeEventDocument[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([bookingId])
  @@index([type])
  @@index([propertyId]) // NEW INDEX
  @@index([warrantyId]) // NEW INDEX
  @@index([policyId])   // NEW INDEX
  @@index([inventoryItemId]) // NEW INDEX
  @@map("documents")
}

// ============================================================================
// MESSAGING SYSTEM
// ============================================================================

model Message {
  id          String      @id @default(uuid())
  bookingId   String?
  senderId    String
  recipientId String
  
  // Message Content
  type        MessageType @default(TEXT)
  content     String
  attachments Json? // Array of file URLs
  
  // Status
  isRead      Boolean     @default(false)
  readAt      DateTime?
  // Relations
  booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@index([bookingId])
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
  @@map("messages")
}

// Add new enum for frequency
enum RecurrenceFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUALLY
  ANNUALLY
}


model MaintenanceTaskTemplate {
  id               String               @id @default(uuid())
  title            String
  description      String?
  defaultFrequency RecurrenceFrequency
  serviceCategory  ServiceCategory?
  
  // NEW fields
  isActive         Boolean @default(true)
  sortOrder        Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("maintenance_task_templates")
}

// ============================================================================
// WARRANTY MANAGEMENT
// ============================================================================

model Warranty {
  id                 String    @id @default(uuid())
  homeownerProfileId String
  category           WarrantyCategory @default(HOME_WARRANTY_PLAN)
  propertyId         String? // Link to a specific property (e.g., HVAC unit warranty is for the main home)
  homeAssetId        String?
  inventoryItemId    String?  // NEW: Direct link to InventoryItem
  // Policy Details
  providerName       String
  policyNumber       String?
  coverageDetails    String?
  cost               Decimal? @db.Decimal(12, 2)
  
  // Dates
  startDate          DateTime
  expiryDate         DateTime
  
  // Relations
  homeownerProfile   HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  property           Property? @relation(fields: [propertyId], references: [id])
  documents          Document[]
  homeAsset          HomeAsset? @relation(fields: [homeAssetId], references: [id])
  inventoryItem      InventoryItem? @relation("WarrantyToInventoryItem", fields: [inventoryItemId], references: [id], onDelete: SetNull)
  
  // PHASE 1: NEW RELATION
  maintenanceTasks PropertyMaintenanceTask[]
  inventoryItems    InventoryItem[]
  claims Claim[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerProfileId])
  @@index([expiryDate])
  @@index([homeAssetId])
  @@index([inventoryItemId])
  @@map("warranties")
}

// ============================================================================
// INSURANCE MANAGEMENT
// ============================================================================

model InsurancePolicy {
  id                 String    @id @default(uuid())
  homeownerProfileId String
  propertyId         String? // Link to the insured property
  
  // Policy Details
  carrierName        String
  policyNumber       String
  coverageType       String? // e.g., "Homeowner", "Landlord", "Flood"
  premiumAmount      Decimal   @db.Decimal(12, 2)
  
  // Dates
  startDate          DateTime
  expiryDate         DateTime
  
  // Relations
  homeownerProfile   HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  property           Property? @relation(fields: [propertyId], references: [id])
  documents          Document[]
  inventoryItems     InventoryItem[]
  claims Claim[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerProfileId])
  @@index([expiryDate])
  @@map("insurance_policies")
}

// ============================================================================
// EXPENSE MANAGEMENT
// ============================================================================

model Expense {
  id                 String          @id @default(uuid())
  homeownerProfileId String
  propertyId         String? // Link to a specific property
  bookingId          String? // Optional link to a platform booking (e.g., a top-up payment)
  
  // Expense Details
  description        String
  category           ExpenseCategory
  amount             Decimal         @db.Decimal(12, 2)
  transactionDate    DateTime
  
  // Relations
  homeownerProfile   HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
  property           Property? @relation(fields: [propertyId], references: [id])
  booking            Booking? @relation(fields: [bookingId], references: [id])
  homeEvents HomeEvent[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([homeownerProfileId])
  @@index([category])
  @@index([transactionDate])
  @@map("expenses")
}

model HomeAsset {
  id          String    @id @default(uuid())
  propertyId  String
  property    Property  @relation(fields: [propertyId], references: [id])
  assetType   String    // e.g., "HVAC_FURNACE", "WATER_HEATER" - should map to an Enum
  installationYear Int? // Year the user installed it (more accurate than age)
  modelNumber String?
  serialNumber String?
  // Optional fields for Maintenance Readiness/Energy:
  lastServiced DateTime? 
  efficiencyRating String?
  warranties  Warranty[]
  
  // PHASE 1: NEW RELATION
  maintenanceTasks PropertyMaintenanceTask[]
  inventoryItems InventoryItem[]

  manufacturer    String?
  brand           String?
  manufacturerNorm String?
  modelNumberNorm  String?

  recallMatches   RecallMatch[]

  @@index([manufacturerNorm, modelNumberNorm])
  
  @@index([propertyId])
  @@unique([propertyId, assetType]) // Usually only one furnace per house
}

model MovingPlan {
  id              String   @id @default(uuid())
  propertyId      String
  closingDate     DateTime
  planData        Json     // Full moving plan (timeline, costs, utilities, etc.)
  completedTasks  String[] // Array of completed task IDs
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([propertyId])
  @@map("moving_plans")
}

model CommunityEvent {
  id              String   @id @default(uuid())
  source          String
  externalEventId String
  title           String
  description     String?
  startTime       DateTime
  endTime         DateTime?
  venueName       String?
  city            String
  state           String
  latitude        Float?
  longitude       Float?
  externalUrl     String
  isActive        Boolean  @default(true)
  lastFetchedAt   DateTime @default(now())
  createdAt       DateTime @default(now())

  @@unique([source, externalEventId])
  @@index([city, state, startTime])
  @@index([isActive, startTime])
}

model CityFeatureFlag {
  id               String  @id @default(uuid())
  city             String
  state            String
  eventsEnabled    Boolean @default(false)
  servicesEnabled  Boolean @default(false)
  alertsEnabled    Boolean @default(false)
  providersEnabled Boolean @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([city, state])
}

model SellerPrepPlan {
  id          String   @id @default(uuid())
  userId      String
  propertyId  String
  preferences Json?    // ADD THIS LINE
  createdAt   DateTime @default(now())

  items       SellerPrepPlanItem[]
  interviews  AgentInterview[]

  @@index([userId, propertyId])
}

model SellerPrepPlanItem {
  id          String   @id @default(uuid())
  planId      String
  code        String
  title       String
  priority    String
  roiRange    String
  costBucket  String
  status      String   @default("PLANNED")
  
  // Timeline tracking
  completedAt DateTime?
  skippedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt  // ADD DEFAULT

  plan        SellerPrepPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([status])
}

model SellerPrepLead {
  id          String   @id @default(uuid())
  userId      String
  propertyId  String
  leadType    String   // AGENT | CONTRACTOR | STAGER
  context     String   // JSON string with task details
  
  // NEW FIELDS for contact info
  fullName    String?
  email       String?
  phone       String?
  contactMethod String? // email | phone | either
  
  createdAt   DateTime @default(now())

  @@index([propertyId, leadType])
}

model SellerPrepFeedback {
  id          String   @id @default(uuid())
  userId      String
  propertyId  String
  rating      String   // "helpful" or "not-helpful"
  comment     String?
  page        String   @default("seller-prep")
  createdAt   DateTime @default(now())

  @@index([propertyId])
  @@index([rating])
  @@index([createdAt])
}

// NEW MODEL: Stores data for the Agent Interview Guide
model AgentInterview {
  id          String   @id @default(uuid())
  planId      String
  
  agentName   String
  isFavorite  Boolean  @default(false)
  
  // Structured Notes (Stored as JSON to handle dynamic interview questions)
  // Format: { "Experience": "...", "Marketing": "...", "Pricing": "...", etc. }
  notes       Json?
  
  totalScore  Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  plan        SellerPrepPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("agent_interviews")
}

// ============================================================================
// INSPECTION REPORTS (HOME_BUYER FEATURE)
// ============================================================================

model InspectionReport {
  id                  String   @id @default(uuid())
  propertyId          String
  userId              String
  
  // Report metadata
  inspectionDate      DateTime?
  inspectorName       String?
  inspectorCompany    String?
  reportType          String?
  
  // PDF storage
  pdfUrl              String?
  pdfFileName         String
  
  // AI Analysis Results
  overallScore        Int      @default(0)
  overallCondition    String   @default("FAIR")
  
  totalIssuesFound    Int      @default(0)
  criticalIssues      Int      @default(0)
  highPriorityIssues  Int      @default(0)
  mediumIssues        Int      @default(0)
  lowIssues           Int      @default(0)
  cosmeticIssues      Int      @default(0)
  
  // Cost estimates
  totalRepairCost     Decimal  @default(0) @db.Decimal(12, 2)
  criticalRepairCost  Decimal  @default(0) @db.Decimal(12, 2)
  recommendedRepairCost Decimal @default(0) @db.Decimal(12, 2)
  
  // Negotiation data
  negotiationScript   String?  @db.Text
  suggestedCredit     Decimal? @db.Decimal(12, 2)
  negotiationPoints   Json?
  
  // Comparison data
  comparableHomes     Json?
  marketContext       String?  @db.Text
  
  // Status
  analysisCompleted   Boolean  @default(false)
  analysisError       String?
  
  // Relations
  property            Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  issues              InspectionIssue[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([propertyId])
  @@index([userId])
  @@map("inspection_reports")
}

model InspectionIssue {
  id                  String   @id @default(uuid())
  reportId            String
  
  // Issue details
  title               String
  description         String   @db.Text
  location            String
  category            String
  
  // Severity & Priority
  severity            String
  urgency             String
  isCritical          Boolean  @default(false)
  
  // Cost estimates
  estimatedCost       Decimal  @db.Decimal(12, 2)
  costRange           Json?
  
  // Inspector notes
  inspectorNotes      String?  @db.Text
  inspectorRecommendation String? @db.Text
  
  // Repair info
  repairRecommendations String[]
  preventativeMeasures  String[]
  estimatedRepairTime   String?
  
  // Maintenance calendar
  needsImmediateAction Boolean @default(false)
  scheduledMaintenanceDate DateTime?
  maintenanceFrequency String?
  
  // Relations
  report              InspectionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([reportId])
  @@index([severity])
  @@index([category])
  @@map("inspection_issues")
}

model LocalUpdate {
  id               String   @id @default(uuid())

  title            String
  shortDescription String

  category         LocalUpdateCategory

  sourceName       String
  isSponsored      Boolean  @default(false)

  ctaText          String
  ctaUrl           String?

  priority         Int      @default(3)

  startDate        DateTime
  endDate          DateTime

  // Location targeting
  zipCodes         String[]
  cities           String[]
  state            String?

  // Eligibility
  propertyTypes    PropertyType[]
  ownerOnly        Boolean  @default(false)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  dismissals       UserLocalUpdateDismissal[]
  events           LocalUpdateEvent[]

  @@index([startDate, endDate])
}

model UserLocalUpdateDismissal {
  id             String   @id @default(uuid())

  userId         String
  localUpdateId  String

  dismissedAt    DateTime @default(now())

  localUpdate    LocalUpdate @relation(fields: [localUpdateId], references: [id], onDelete: Cascade)

  @@unique([userId, localUpdateId])
  @@index([userId])
}
model LocalUpdateEvent {
  id             String   @id @default(uuid())

  userId         String?
  localUpdateId  String

  eventType      LocalUpdateEventType

  createdAt      DateTime @default(now())

  localUpdate    LocalUpdate @relation(fields: [localUpdateId], references: [id], onDelete: Cascade)

  @@index([localUpdateId])
}

// ===============================
// Orchestration Action Events
// ===============================

model OrchestrationActionEvent {
  id            String   @id @default(cuid())

  // Scope
  propertyId    String
  actionKey     String   // canonical identity (stable across recalculations)

  // Event semantics
  actionType    OrchestrationActionEventType
  source        OrchestrationActionSource

  primarySourceType  SignalSourceType? // optional cache
  primarySourceLabel String?           // optional cache
  primaryConfidence  Float?            // optional cache

  // Metadata / audit
  payload       Json?
  createdBy     String?  // userId (nullable for system actions)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt

  // Performance + idempotency
  @@index([propertyId])
  @@index([propertyId, actionKey])
  @@index([actionKey])

  // Guarantees idempotency per action type
  @@unique([propertyId, actionKey, actionType])
}

enum OrchestrationActionEventType {
  USER_MARKED_COMPLETE
  USER_UNMARKED_COMPLETE
  USER_DISMISSED
  SYSTEM_SUPPRESSED
  SYSTEM_UNSUPPRESSED
}

enum OrchestrationActionSource {
  USER
  SYSTEM
}

model OrchestrationActionSnooze {
  id            String   @id @default(uuid())
  propertyId    String
  actionKey     String
  
  snoozedAt     DateTime @default(now())
  snoozeUntil   DateTime
  snoozeReason  String?
  
  endedAt       DateTime?  // When un-snoozed or auto-expired
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([propertyId, actionKey])
  @@index([snoozeUntil])
  @@map("orchestration_action_snoozes")
}

model OrchestrationActionCompletion {
  id            String   @id @default(uuid())
  
  // Scope
  propertyId    String
  actionKey     String   // Links to orchestration action
  eventId       String   @unique // Links to USER_MARKED_COMPLETE event
  
  // Completion details
  completedAt   DateTime
  costAmount    Decimal? @db.Decimal(10, 2)
  costCurrency  String   @default("USD")
  didItMyself   Boolean  @default(false)
  
  serviceProviderName   String?
  serviceProviderRating Int? // 1-5
  
  notes         String?  @db.Text
  photoCount    Int      @default(0)
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?  // userId
  undoneAt      DateTime? // If user undoes completion
  
  // Relations
  photos        OrchestrationActionCompletionPhoto[]
  
  @@index([propertyId, actionKey])
  @@index([propertyId, completedAt])
  @@index([serviceProviderName])
  @@map("orchestration_action_completions")
}

model OrchestrationActionCompletionPhoto {
  id            String   @id @default(uuid())
  
  completionId  String?
  propertyId    String
  
  // File metadata
  fileName      String
  fileSizeBytes Int
  mimeType      String
  
  // URLs (PLACEHOLDER - will store S3 URLs when image processing is implemented)
  originalUrl   String
  thumbnailUrl  String
  
  // Dimensions
  width         Int?
  height        Int?
  
  orderIndex    Int      @default(0)
  uploadedAt    DateTime @default(now())
  
  // Relations
  completion    OrchestrationActionCompletion? @relation(fields: [completionId], references: [id], onDelete: Cascade)
  @@index([completionId])
  @@index([propertyId])
  @@map("orchestration_action_completion_photos")
}


model OrchestrationDecisionTrace {
  id          String   @id @default(uuid())

  // Scope
  propertyId  String
  actionKey   String   // canonical identity (stable)

  // Snapshot metadata
  computedAt  DateTime @default(now())
  algoVersion String?  // optional: "v1", "phase8-coverage", etc.

  // Persisted explanation payloads
  signals     Json?    // age, last service, coverage, assumptions, etc.
  confidence  Json?    // confidence drivers and score/level
  suppression Json?    // suppressionSource + reasons (if any)
  steps       Json     // DecisionTraceStep[] (ordered)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([propertyId, actionKey])
  @@index([propertyId])
  @@index([actionKey])
  @@map("orchestration_decision_traces")
}

// ===============================
// SIGNAL SOURCE TAGGING
// ===============================

enum SignalSourceType {
  SCHEDULED     // â± Time-based / cron / seasonal
  INTELLIGENCE  // ðŸ“Š Risk model / AI / prediction
  COVERAGE      // ðŸ“„ Insurance / warranty derived
  MANUAL        // ðŸ‘¤ User initiated
  SENSOR        // ðŸ”” IoT / telemetry
  DOCUMENT      // ðŸ§¾ OCR/PDF extraction
  EXTERNAL      // ðŸŒŽ CPSC/NOAA/3rd-party feeds (optional but useful)
}

enum SignalTriggerType {
  RULE          // deterministic rule fired
  MODEL         // probabilistic model output
  EXTRACTION    // OCR/doc parsing
  USER_ACTION   // explicit user action
  SCHEDULE      // cron/time-based
  INGEST        // external feed ingestion
}

enum DerivedFromType {
  RISK_ASSESSMENT
  POLICY
  WARRANTY
  DOCUMENT
  INVENTORY_ITEM
  RECALL_RECORD
  WEATHER_EVENT
  USER_EVENT
}


model SignalProvenance {
  id              String           @id @default(uuid())
  propertyId  String

  // Core taxonomy
  sourceType       SignalSourceType
  triggerType      SignalTriggerType

  // Optional â€œwhere it came fromâ€
  sourceSystem     String?          // e.g. "coverageLapseJob", "freezeRiskModel", "ocrLabel", "cpscIngest"
  sourceVersion    String?          // model version, ruleset version, pipeline version
  sourceRunId      String?          // jobRunId / batchId / ingestionRunId / workflowRunId

  // Optional linkage to the underlying evidence/inputs
  derivedFromType  DerivedFromType?         // "RISK_ASSESSMENT" | "POLICY" | "WARRANTY" | "DOCUMENT" | "INVENTORY_ITEM" etc.
  derivedFromId    String?          // id of the evidence record
  externalRef      String?          // provider id or URL-safe id (e.g., CPSC recall id)

  // Explainability
  label            String?          // short UI label override (rare)
  summary          String?          // 1-line â€œwhy this appearedâ€
  details          Json?            // structured payload: thresholds, features, matched fields, etc.
  confidence       Float?           // 0..1 (or 0..100) â€“ pick one convention
  severityScore    Float?           // optional numeric strength signal separate from confidence

  // Polymorphic target (links provenance to a thing in your system)
  targetType       String           // "ORCHESTRATED_ACTION" | "INCIDENT" | "NOTIFICATION" | "TASK" | "CLAIM_INSIGHT"
  targetId         String

  createdAt        DateTime         @default(now())
  attributions    SignalAttribution[]

  @@index([propertyId])
  @@index([propertyId, targetType, targetId])

  @@index([targetType, targetId])
  @@index([sourceType])
  @@index([sourceSystem])
}

model SignalAttribution {
  id             String @id @default(uuid())
  provenanceId   String
  provenance     SignalProvenance @relation(fields: [provenanceId], references: [id], onDelete: Cascade)

  rank           Int    @default(0)    // 0 = primary
  weight         Float?                 // e.g. contribution score

  @@index([provenanceId])
}


// =============================================================================
// SEASONAL MAINTENANCE MODELS
// =============================================================================

model SeasonalTaskTemplate {
  id                    String           @id @default(cuid())
  taskKey               String           @unique @map("task_key")
  season                Season
  title                 String
  description           String?
  whyItMatters          String?          @map("why_it_matters")
  typicalCostMin        Decimal?         @map("typical_cost_min") @db.Decimal(10, 2)
  typicalCostMax        Decimal?         @map("typical_cost_max") @db.Decimal(10, 2)
  isDiyPossible         Boolean          @default(false) @map("is_diy_possible")
  diyDifficulty         String?          @default("MODERATE") @map("diy_difficulty")
  tutorialUrl           String?          @map("tutorial_url")
  materialsList         String?          @map("materials_list")
  safetyWarning         String?          @map("safety_warning")
  estimatedHours        Decimal?         @map("estimated_hours") @db.Decimal(4, 1)
  priority              TaskPriority     @default(RECOMMENDED)
  serviceCategory       String?          @map("service_category")
  climateRegions        ClimateRegion[]  @map("climate_regions")
  requiredAssetType     String?          @map("required_asset_type")
  requiredAssetCheck    String?          @map("required_asset_check")
  timingOffsetDays      Int              @default(-14) @map("timing_offset_days")
  recurrencePattern     String           @default("ANNUAL") @map("recurrence_pattern")
  isActive              Boolean          @default(true) @map("is_active")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  
  // Relations
  seasonalChecklistItems SeasonalChecklistItem[]
  
  @@index([season])
  @@index([isActive, priority])
  @@map("seasonal_task_templates")
}

model SeasonalChecklist {
  id                   String                  @id @default(cuid())
  propertyId           String                  @map("property_id")
  season               Season
  year                 Int
  climateRegion        ClimateRegion           @map("climate_region")
  seasonStartDate      DateTime                @map("season_start_date") @db.Date
  seasonEndDate        DateTime                @map("season_end_date") @db.Date
  status               SeasonalChecklistStatus @default(PENDING)
  totalTasks           Int                     @default(0) @map("total_tasks")
  tasksAdded           Int                     @default(0) @map("tasks_added")
  tasksCompleted       Int                     @default(0) @map("tasks_completed")
  generatedAt          DateTime                @default(now()) @map("generated_at")
  firstViewedAt        DateTime?               @map("first_viewed_at")
  notificationSentAt   DateTime?               @map("notification_sent_at")
  dismissedAt          DateTime?               @map("dismissed_at")
  createdAt            DateTime                @default(now()) @map("created_at")
  updatedAt            DateTime                @updatedAt @map("updated_at")
  
  // Relations
  property             Property                @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items                SeasonalChecklistItem[]
  
  @@unique([propertyId, season, year])
  @@index([propertyId])
  @@index([status, seasonStartDate])
  @@map("seasonal_checklists")
}

model SeasonalChecklistItem {
  id                       String                @id @default(cuid())
  seasonalChecklistId      String                @map("seasonal_checklist_id")
  seasonalTaskTemplateId   String                @map("seasonal_task_template_id")
  propertyId               String                @map("property_id")
  checklistItemId          String?               @unique @map("checklist_item_id")
  taskKey                  String                @map("task_key")
  title                    String
  description              String?
  priority                 TaskPriority          @default(RECOMMENDED)
  status                   SeasonalTaskStatus    @default(RECOMMENDED)
  recommendedDate          DateTime?             @map("recommended_date") @db.Date
  addedAt                  DateTime?             @map("added_at")
  completedAt              DateTime?             @map("completed_at")
  dismissedAt              DateTime?             @map("dismissed_at")
  snoozedUntil             DateTime?             @map("snoozed_until")
  createdAt                DateTime              @default(now()) @map("created_at")
  updatedAt                DateTime              @updatedAt @map("updated_at")
  
  // Relations
  seasonalChecklist        SeasonalChecklist     @relation(fields: [seasonalChecklistId], references: [id], onDelete: Cascade)
  seasonalTaskTemplate     SeasonalTaskTemplate  @relation(fields: [seasonalTaskTemplateId], references: [id])
  property                 Property              @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  checklistItem            ChecklistItem?        @relation(fields: [checklistItemId], references: [id], onDelete: SetNull)
  
  // PHASE 1: NEW RELATION
  maintenanceTask PropertyMaintenanceTask?
  
  @@index([seasonalChecklistId])
  @@index([propertyId, status])
  @@index([checklistItemId])
  @@map("seasonal_checklist_items")
}

model PropertyClimateSetting {
  id                      String              @id @default(cuid())
  propertyId              String              @unique @map("property_id")
  climateRegion           ClimateRegion       @map("climate_region")
  climateRegionSource     String              @default("AUTO_DETECTED") @map("climate_region_source")
  notificationTiming      NotificationTiming  @default(STANDARD) @map("notification_timing")
  notificationEnabled     Boolean             @default(true) @map("notification_enabled")
  autoGenerateChecklists  Boolean             @default(true) @map("auto_generate_checklists")
  customSeasonDates       Json?               @map("custom_season_dates")
  excludedTaskKeys        String[]            @default([]) @map("excluded_task_keys")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")
  
  // Relations
  property                Property            @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  @@index([propertyId])
  @@index([climateRegion])
  @@map("property_climate_settings")
}

model PropertyFinanceSnapshot {
  id                 String   @id @default(uuid())
  propertyId          String   @unique
  mortgageBalance     Float?
  interestRate        Float?   // decimal, e.g. 0.0625
  remainingTermMonths Int?
  monthlyPayment      Float?   // optional override; if null, computed
  lastVerifiedAt      DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

model ToolOverride {
  id         String   @id @default(uuid())
  propertyId  String
  toolKey     String   // e.g. "SELL_HOLD_RENT"
  key         String   // e.g. "monthlyRentNow", "appreciationRate"
  value       Float
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, toolKey, key])
  @@index([propertyId, toolKey])
}


// ============================================================================
// HOME TIMELINE
// ============================================================================

enum HomeEventType {
  PURCHASE
  DOCUMENT
  REPAIR
  MAINTENANCE
  CLAIM
  IMPROVEMENT
  VALUE_UPDATE
  INSPECTION
  NOTE
  MILESTONE
  OTHER
}

enum HomeEventImportance {
  LOW
  NORMAL
  HIGH
  HIGHLIGHT
}

enum HomeEventVisibility {
  PRIVATE
  HOUSEHOLD
  SHARE_LINK
  RESALE_PACK
}

enum HomeEventDocumentKind {
  PHOTO
  RECEIPT
  INVOICE
  PDF
  BEFORE
  AFTER
  OTHER
}

model HomeEvent {
  id              String   @id @default(uuid())
  propertyId      String
  createdById     String?

  roomId          String?
  inventoryItemId String?
  claimId         String?
  expenseId       String?

  type            HomeEventType
  subtype         String?
  importance      HomeEventImportance @default(NORMAL)
  visibility      HomeEventVisibility @default(HOUSEHOLD)

  occurredAt      DateTime
  endAt           DateTime?

  title           String
  summary         String?

  // Money/value signals (align with Expense using Decimal)
  amount          Decimal? @db.Decimal(12, 2)
  currency        String?  @default("USD")
  valueDelta      Decimal? @db.Decimal(12, 2)

  meta            Json?
  groupKey        String?
  idempotencyKey  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy       User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  room            InventoryRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  claim           Claim?         @relation(fields: [claimId], references: [id], onDelete: SetNull)
  expense         Expense?       @relation(fields: [expenseId], references: [id], onDelete: SetNull)

  documents       HomeEventDocument[]

  @@index([propertyId, occurredAt])
  @@index([propertyId, type, occurredAt])
  @@index([propertyId, roomId, occurredAt])
  @@index([propertyId, inventoryItemId, occurredAt])
  @@index([propertyId, claimId, occurredAt])
  @@index([propertyId, importance, occurredAt])
  @@index([propertyId, groupKey])

  @@unique([propertyId, idempotencyKey])
  @@map("home_events")
}

model HomeEventDocument {
  id         String @id @default(uuid())
  eventId    String
  documentId String

  kind       HomeEventDocumentKind @default(OTHER)
  caption    String?
  sortOrder  Int @default(0)

  createdAt  DateTime @default(now())

  event      HomeEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([eventId, documentId])
  @@index([eventId])
  @@index([documentId])
  @@map("home_event_documents")
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id          String       @id @default(uuid())
  bookingId   String       @unique
  authorId    String
  providerId  String
  
  // Rating (1-5)
  rating      Int
  
  // Review Content
  title       String?
  content     String
  
  // Review Categories (1-5 each)
  qualityRating      Int?
  communicationRating Int?
  valueRating        Int?
  professionalismRating Int?
  // Moderation
  status      ReviewStatus @default(PENDING)
  moderatedAt DateTime?
  moderatedBy String? // admin userId
  
  // Provider Response
  response    String?
  respondedAt DateTime?
  // Relations
  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  author   User    @relation("ReviewAuthor", fields: [authorId], references: [id])
  provider User    @relation("ReviewProvider", fields: [providerId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([providerId])
  @@index([rating])
  @@index([status])
  @@map("reviews")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id          String   @id @default(uuid())
  userId      String

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String
  title       String
  message     String
  actionUrl   String?

  entityType  String?
  entityId    String?

  isRead      Boolean  @default(false)
  readAt      DateTime?

  metadata    Json?
  createdAt   DateTime @default(now())

  deliveries  NotificationDelivery[]
  
  recallMatchId String?
  recallMatch   RecallMatch? @relation(fields: [recallMatchId], references: [id], onDelete: SetNull)

  @@index([recallMatchId])

  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([entityType, entityId])
}


model NotificationDelivery {
  id                 String   @id @default(uuid())
  notificationId     String
  channel            NotificationChannel

  status             DeliveryStatus @default(PENDING)
  sentAt             DateTime?
  failureReason      String?
  digestId           String?
  providerMessageId  String?

  enqueuedAt         DateTime?

  createdAt          DateTime @default(now())

  notification       Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, channel])
  @@index([channel, status])
  @@index([channel, status, enqueuedAt])
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
  WHATSAPP
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

// ============================================================================
// PDF REPORTS
// ============================================================================

enum HomeReportExportType {
  HOME_SUMMARY
  INVENTORY
  MAINTENANCE_HISTORY
  COVERAGE_SNAPSHOT
  HOME_REPORT_PACK
}

enum HomeReportExportStatus {
  PENDING
  GENERATING
  READY
  FAILED
  EXPIRED
  DELETED
}

enum HomeReportExportEventType {
  CREATED
  GENERATION_STARTED
  GENERATED
  DOWNLOADED
  SHARED
  SHARE_REVOKED
  FAILED
  EXPIRED
  DELETED
}

model HomeReportExport {
  id         String @id @default(uuid())
  userId     String
  propertyId String

  type       HomeReportExportType
  status     HomeReportExportStatus @default(PENDING)

  // Section toggles / configuration for report-pack
  sections   Json?

  // Reproducibility (prevents â€œwhy did this change later?â€)
  templateVersion Int @default(1)
  dataVersion     Int @default(1)
  snapshot        Json? // store the final computed DTO used to render

  // Optional: store generated PDF as a Document row (recommended)
  documentId String?
  document   Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  // Shareable link support (no second table needed)
  shareToken     String?   @unique
  shareExpiresAt DateTime?
  shareRevokedAt DateTime?

  storageBucket String?
  storageKey    String?  @unique
  expiresAt     DateTime?


  // Lifecycle
  requestedAt DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  errorMessage String?

  // Useful metadata
  locale   String?
  timezone String?

  deletedAt       DateTime?
  deletedByUserId String?
  regeneratedFromId String?

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  events   HomeReportExportEvent[]

  @@index([userId, requestedAt])
  @@index([propertyId, requestedAt])
  @@index([status, requestedAt])
  @@index([shareToken])

  @@map("home_report_exports")
}

model HomeReportExportEvent {
  id        String @id @default(uuid())
  reportId  String
  type      HomeReportExportEventType
  createdAt DateTime @default(now())
  meta      Json?

  report HomeReportExport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
  @@map("home_report_export_events")
}

// ============================================================================
// CLAIMS
// ============================================================================

enum ClaimStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  CLOSED
}

enum ClaimType {
  WATER_DAMAGE
  FIRE_SMOKE
  STORM_WIND_HAIL
  THEFT_VANDALISM
  LIABILITY
  HVAC
  PLUMBING
  ELECTRICAL
  APPLIANCE
  OTHER
}

enum ClaimSourceType {
  INSURANCE
  HOME_WARRANTY
  MANUFACTURER_WARRANTY
  OUT_OF_POCKET
  UNKNOWN
}

enum ClaimChecklistStatus {
  OPEN
  DONE
  NOT_APPLICABLE
}

enum ClaimDocumentType {
  PHOTO
  VIDEO
  INVOICE
  ESTIMATE
  REPORT
  POLICY
  COMMUNICATION
  RECEIPT
  OTHER
}

enum ClaimTimelineEventType {
  CREATED
  CHECKLIST_GENERATED
  DOCUMENT_ADDED
  SUBMITTED
  INSPECTION_SCHEDULED
  INSPECTION_COMPLETED
  ESTIMATE_RECEIVED
  FOLLOW_UP
  APPROVED
  DENIED
  SETTLEMENT_ISSUED
  CLOSED
  NOTE
  STATUS_CHANGE
  OTHER
}

enum DomainEventType {
  CLAIM_SUBMITTED
  CLAIM_CLOSED
  FOLLOW_UP_DUE
}

enum DomainEventStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
}

model Claim {
  id          String @id @default(uuid())
  propertyId  String
  createdBy   String // userId

  title       String
  description String?
  type        ClaimType
  status      ClaimStatus @default(DRAFT)

  sourceType   ClaimSourceType @default(UNKNOWN)
  providerName String?
  claimNumber  String?
  externalUrl  String?

  // Coverage references (optional)
  insurancePolicyId String?
  warrantyId        String?

  incidentAt   DateTime?
  openedAt     DateTime?
  submittedAt  DateTime?
  closedAt     DateTime?

  deductibleAmount     Decimal? @db.Decimal(12, 2)
  estimatedLossAmount  Decimal? @db.Decimal(12, 2)
  settlementAmount     Decimal? @db.Decimal(12, 2)

  checklistCompletionPct Int? @default(0)
  lastActivityAt         DateTime @default(now())
  nextFollowUpAt         DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property       Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  creator        User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  insurancePolicy InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id], onDelete: SetNull)
  warranty        Warranty?        @relation(fields: [warrantyId], references: [id], onDelete: SetNull)

  checklistItems ClaimChecklistItem[]
  documents      ClaimDocument[]
  timelineEvents ClaimTimelineEvent[]
  homeEvents HomeEvent[]

  @@index([propertyId, status])
  @@index([createdBy, status])
  @@index([propertyId, lastActivityAt])
  @@index([nextFollowUpAt])
  @@map("claims")
}

model ClaimChecklistItem {
  id          String @id @default(uuid())
  claimId     String

  orderIndex  Int
  title       String
  description String?
  required    Boolean @default(false)

  status      ClaimChecklistStatus @default(OPEN)
  completedAt DateTime?
  completedBy String?

  primaryClaimDocumentId String?

  requiredDocTypes     ClaimDocumentType[] @default([])
  requiredDocMinCount  Int @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  claim       Claim @relation(fields: [claimId], references: [id], onDelete: Cascade)

  primaryClaimDocument ClaimDocument? @relation("ClaimChecklistPrimaryDoc", fields: [primaryClaimDocumentId], references: [id], onDelete: SetNull)

  itemDocuments ClaimChecklistItemDocument[]

  @@unique([claimId, orderIndex])
  @@index([claimId, status])
  @@map("claim_checklist_items")
}

model ClaimChecklistItemDocument {
  id                  String @id @default(uuid())
  claimChecklistItemId String
  claimDocumentId      String
  createdAt            DateTime @default(now())

  item         ClaimChecklistItem @relation(fields: [claimChecklistItemId], references: [id], onDelete: Cascade)
  claimDocument ClaimDocument      @relation(fields: [claimDocumentId], references: [id], onDelete: Cascade)

  @@unique([claimChecklistItemId, claimDocumentId])
  @@index([claimChecklistItemId])
  @@index([claimDocumentId])
  @@map("claim_checklist_item_documents")
}


model ClaimDocument {
  id         String @id @default(uuid())
  claimId    String
  documentId String

  type       ClaimDocumentType @default(OTHER)
  title      String?
  notes      String?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  claim      Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  checklistPrimaryFor ClaimChecklistItem[] @relation("ClaimChecklistPrimaryDoc")
  timelineEvents ClaimTimelineEvent[]
  itemDocuments   ClaimChecklistItemDocument[]

  @@unique([claimId, documentId])
  @@index([claimId, type])
  @@index([documentId])
  @@map("claim_documents")
}

model ClaimTimelineEvent {
  id          String @id @default(uuid())
  claimId     String
  propertyId  String
  createdBy   String // userId

  type        ClaimTimelineEventType
  title       String?
  description String?

  occurredAt  DateTime @default(now())
  meta        Json?

  // Optional attachment
  claimDocumentId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  claim       Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  creator     User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  claimDocument ClaimDocument? @relation(fields: [claimDocumentId], references: [id], onDelete: SetNull)

  @@index([claimId, occurredAt])
  @@index([propertyId, occurredAt])
  @@map("claim_timeline_events")
}

model DomainEvent {
  id          String @id @default(uuid())
  type        DomainEventType
  status      DomainEventStatus @default(PENDING)

  // Scope / routing
  propertyId  String?
  userId      String?

  // Optional idempotency key to prevent duplicates
  idempotencyKey String? @unique

  // Payload for consumers (workers/notifications)
  payload     Json

  attempts    Int @default(0)
  lastError   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  processedAt DateTime?

  @@index([status, createdAt])
  @@index([type, status])
  @@map("domain_events")
}

// ============================================================================
// RECALL
// ============================================================================

enum RecallSource {
  CPSC        // US Consumer Product Safety Commission (v1)
  NHTSA       // Vehicle recalls (future)
  MANUFACTURER
  USER_REPORTED
}

enum RecallStatus {
  ACTIVE
  ENDED
  UNKNOWN
}

enum RecallSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
  UNKNOWN
}

enum RecallMatchStatus {
  OPEN                  // active alert (confirmed or high-confidence)
  NEEDS_CONFIRMATION     // medium confidence - user confirmation required
  DISMISSED              // user said "not my model"
  RESOLVED               // user handled recall / fixed / replaced
}

enum RecallResolutionType {
  FIXED
  REPLACED
  REFUNDED
  NOT_APPLICABLE
  IGNORED
  OTHER
}

enum RecallMatchMethod {
  MAKE_MODEL
  SERIAL
  UPC
  SKU
  TEXT_FUZZY
}

model RecallRecord {
  id            String       @id @default(uuid())

  source        RecallSource
  externalId    String       // e.g., CPSC recall ID / release ID
  status        RecallStatus @default(ACTIVE)
  severity      RecallSeverity @default(UNKNOWN)

  title         String
  summary       String?
  hazard        String?       // e.g., "Fire hazard"
  remedy        String?       // e.g., "Stop use and contact manufacturer"
  remedyUrl     String?
  recallUrl     String?

  recalledAt    DateTime?     // date recall announced
  lastSeenAt    DateTime      @default(now()) // ingestion heartbeat
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // optional structured fields
  affectedUnits String?
  countryCodes  String[]      @default(["US"])
  raw           Json?         // store raw payload for traceability/debug

  // relations
  products      RecallProduct[]
  matches       RecallMatch[]

  @@unique([source, externalId])
  @@index([source, status])
  @@index([recalledAt])
}

model RecallProduct {
  id            String   @id @default(uuid())
  recallId      String
  recall        RecallRecord @relation(fields: [recallId], references: [id], onDelete: Cascade)

  // normalized matching fields
  manufacturer  String?  // "Whirlpool"
  brand         String?  // "KitchenAid"
  model         String?  // "KDTM404KPS"
  modelRange    String?  // optional range patterns (future)
  upc           String?
  sku           String?
  serialPrefix  String?

  category      InventoryItemCategory? // leverage your existing enum
  notes         String?

  createdAt     DateTime @default(now())

  @@index([recallId])
  @@index([manufacturer, model])
  @@index([upc])
}

model RecallMatch {
  id              String   @id @default(uuid())

  propertyId      String
  inventoryItemId String?
  homeAssetId     String?

  recallId        String
  recall          RecallRecord @relation(fields: [recallId], references: [id], onDelete: Cascade)

  method          RecallMatchMethod @default(MAKE_MODEL)
  confidencePct   Int       @default(0)  // 0-100
  status          RecallMatchStatus @default(OPEN)

  // optional details for explainability / audit
  matchedOn       Json?     // store fields used (manufacturer/model etc)
  rationale       String?   // human-readable explanation

  // user workflow fields
  confirmedAt     DateTime?
  dismissedAt     DateTime?
  resolvedAt      DateTime?
  resolutionType  RecallResolutionType?
  resolutionNotes String?

  // linking to generated follow-ups
  maintenanceTaskId String? @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // relations
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  homeAsset       HomeAsset? @relation(fields: [homeAssetId], references: [id], onDelete: SetNull)
  maintenanceTask PropertyMaintenanceTask? @relation(fields: [maintenanceTaskId], references: [id], onDelete: SetNull)
  notifications   Notification[]

  @@index([propertyId, status])
  @@index([inventoryItemId])
  @@index([homeAssetId])
  @@index([recallId])
  // Prevent duplicates for same recall+asset within a property (important for idempotency)
  @@unique([propertyId, recallId, inventoryItemId])
  @@unique([propertyId, recallId, homeAssetId])
}


// ============================
// Incidents (NEW)
// ============================

enum IncidentStatus {
  DETECTED
  EVALUATED
  ACTIVE
  ACTIONED
  MITIGATED
  RESOLVED
  SUPPRESSED
  EXPIRED
}

enum IncidentSeverity {
  INFO
  WARNING
  CRITICAL
}

enum IncidentSourceType {
  WEATHER
  COVERAGE
  MODEL
  IOT
  MANUAL
  SYSTEM
}

enum SignalType {
  WEATHER_FORECAST
  COVERAGE_CHECK
  MODEL_OUTPUT
  SENSOR_READING
  USER_REPORT
  SYSTEM_RULE
  INSURANCE_POLICY_EXPIRY
  WEATHER_FORECAST_MIN_TEMP
}

enum IncidentActionType {
  TASK
  BOOKING
  CHECKLIST_ITEM
  NOTIFICATION
  DOCUMENT
  NOTE
}

enum IncidentActionStatus {
  PROPOSED
  CREATED
  IN_PROGRESS
  COMPLETED
  CANCELED
  FAILED
}

enum SuppressionScope {
  PROPERTY
  USER
  GLOBAL
}

enum SuppressionReason {
  BOOKING_EXISTS
  TASK_EXISTS
  COVERED
  USER_ACKED
  USER_DISMISSED
  SNOOZED
  RECENTLY_SHOWN
  LOW_CONFIDENCE
  NOT_ACTIONABLE
}

enum AcknowledgementType {
  ACKNOWLEDGED
  DISMISSED
  SNOOZED
}

model Incident {
  id               String            @id @default(cuid())
  propertyId       String
  userId           String?
  sourceType       IncidentSourceType

  roomId           String?
  room             InventoryRoom?    @relation(fields: [roomId], references: [id], onDelete: SetNull)

  typeKey          String
  category         String?
  title            String
  summary          String?
  details          Json?

  status           IncidentStatus    @default(DETECTED)
  openedAt         DateTime          @default(now())
  activatedAt      DateTime?
  mitigatedAt      DateTime?
  resolvedAt       DateTime?
  expiredAt        DateTime?

  severity         IncidentSeverity?
  severityScore    Int?
  scoreBreakdown   Json?
  confidence       Int?

  fingerprint      String
  recurrenceKey    String?
  dedupeWindowMins Int?

  isSuppressed     Boolean           @default(false)
  suppressedAt     DateTime?
  suppressionReason String?
  suppressionRuleId String?
  events           IncidentEvent[]
  snapshots        IncidentScoreSnapshot[]
  snoozedUntil     DateTime?

  severityBreakdown  Json?
  decisionTrace      Json?
  lastEvaluatedAt    DateTime?
  nextReevalAt       DateTime?

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  signals          IncidentSignal[]
  actions          IncidentAction[]
  acknowledgements IncidentAcknowledgement[]

  property         Property          @relation(fields: [propertyId], references: [id])

  @@index([roomId])
  @@index([propertyId, status, severity])
  @@index([propertyId, typeKey, isSuppressed])
  @@index([propertyId, fingerprint])
}

model IncidentSignal {
  id          String     @id @default(cuid())
  incidentId  String
  signalType  SignalType
  externalRef String?
  observedAt  DateTime   @default(now())

  payload     Json
  scoreHint   Int?
  confidence  Int?

  createdAt   DateTime   @default(now())

  incident    Incident   @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, signalType])
  @@index([signalType, observedAt])
}

model IncidentAction {
  id         String              @id @default(cuid())
  incidentId String

  type       IncidentActionType
  status     IncidentActionStatus @default(PROPOSED)

  actionKey   String?
  decisionTrace Json?

  entityType String?
  entityId   String?

  ctaLabel   String?
  ctaUrl     String?
  payload    Json?

  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  incident   Incident            @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, type, status])
  @@index([entityType, entityId])
  @@index([incidentId])
  @@unique([actionKey])
}

model IncidentSuppressionRule {
  id            String           @id @default(cuid())
  scope         SuppressionScope @default(PROPERTY)
  propertyId    String?
  userId        String?

  typeKey       String?
  assetId       String?
  reason        SuppressionReason
  isEnabled     Boolean          @default(true)

  params        Json?
  suppressUntil DateTime?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([propertyId, isEnabled])
  @@index([userId, isEnabled])
  @@index([typeKey, isEnabled])
}

model IncidentAcknowledgement {
  id          String              @id @default(cuid())
  incidentId  String
  userId      String
  type        AcknowledgementType
  note        String?
  snoozeUntil DateTime?

  createdAt   DateTime            @default(now())

  incident    Incident            @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, userId])
  @@index([userId, createdAt])
}

// ============================
// Incident events / timeline (NEW)
// ============================

enum IncidentEventType {
  CREATED
  STATUS_CHANGED
  SEVERITY_COMPUTED
  ACTION_PROPOSED
  ACTION_CREATED
  SUPPRESSED
  ACKNOWLEDGED
  DISMISSED
  SNOOZED
  RESOLVED
  EXPIRED
}

model IncidentEvent {
  id          String            @id @default(cuid())
  incidentId  String
  propertyId  String
  userId      String?
  type        IncidentEventType
  message     String?
  payload     Json?

  createdAt   DateTime          @default(now())

  incident    Incident          @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, createdAt])
  @@index([propertyId, createdAt])
}

model IncidentScoreSnapshot {
  id            String          @id @default(cuid())
  incidentId    String
  computedAt    DateTime        @default(now())

  severity      IncidentSeverity
  severityScore Int
  confidence    Int?
  breakdown     Json
  modelVersion  String?

  incident      Incident        @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId, computedAt])
}

// ============================================================================
// ROOM DESIGN
// ============================================================================

enum RoomType {
  KITCHEN
  LIVING_ROOM
  BEDROOM
  BATHROOM
  DINING
  LAUNDRY
  GARAGE
  OFFICE
  BASEMENT
  OTHER
}

enum RoomChecklistStatus {
  OPEN
  DONE
}

enum RoomChecklistFrequency {
  ONCE
  WEEKLY
  MONTHLY
  QUARTERLY
  SEASONAL
}

model RoomChecklistItem {
  id         String @id @default(uuid())
  propertyId String
  roomId     String

  // Optional â€œstable keyâ€ to ship default items later without duplicates
  key        String?

  title      String
  notes      String?

  status     RoomChecklistStatus    @default(OPEN)
  frequency  RoomChecklistFrequency @default(ONCE)

  sortOrder  Int @default(0)

  lastCompletedAt DateTime?
  nextDueDate     DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property   Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  room       InventoryRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([propertyId, roomId])
  @@index([roomId, status])
  @@unique([roomId, key])
  @@map("room_checklist_items")
}


// ============================================================================
// FAVORITES
// ============================================================================

model Favorite {
  id                String   @id @default(uuid())
  userId            String
  providerProfileId String
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  // FIX: ADDED MISSING RELATION FIELD TO ProviderProfile
  providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, providerProfileId])
  @@index([userId])
  @@map("favorites")
}

// 
// ============================================================================
// SYSTEM TABLES
// ============================================================================

model AuditLog {
  id         String   @id @default(uuid())
  
  // Who & What
  userId     String?
  action     String   // created_booking, updated_payment, etc.
  entityType String   // booking, payment, user, etc.
  entityId   String
  
  // Changes
  oldValues  Json?
  newValues  Json?
  
  // Context
  ipAddress  String?
  userAgent  String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json
  
  description String?
  updatedAt DateTime @updatedAt
  
  @@map("system_settings")
}