# In infrastructure/kubernetes/monitoring/prometheus/prometheus-values.yaml
# Used to customize the prometheus-community/kube-prometheus-stack Helm chart

prometheus:
  prometheusSpec:
    # This section allows you to inject custom scrape jobs into Prometheus's configuration.
    additionalScrapeConfigs:

      # Job to globally drop metrics targets from noisy system/infra namespaces.
      - job_name: 'namespace-filter-drop-list'
        
        # This uses Kubernetes Service Discovery (Pod role) to find all scrape targets.
        kubernetes_sd_configs:
          - role: pod
        
        # This section filters targets before Prometheus scrapes them.
        relabel_configs:
        # --- ADD THIS RULE START ---
        # Ignore Redis (6379) to prevent "Cross Protocol Scripting" alerts
          - source_labels: [__address__]
            regex: '.*:(6379|5432)'
            action: drop
          # --- ADD THIS RULE END ---
          # DROP all targets whose namespace label matches this regex list.
          # Including 'default' and 'monitoring' (where Prometheus itself lives) 
          # prevents self-monitoring metric duplication and noise.
          - source_labels: [__meta_kubernetes_namespace]
            regex: 'kube-system|kube-public|monitoring|argocd|default|cattle-system|kube-node-lease'
            action: drop
          
          # Standard labels that must be retained
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
            action: replace
          
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
            action: replace