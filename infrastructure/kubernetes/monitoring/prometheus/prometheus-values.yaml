# In infrastructure/kubernetes/monitoring/prometheus/prometheus-values.yaml

prometheus:
  prometheusSpec:
    # --- STORAGE MIGRATION START ---
    # Provision a 10Gi replicated volume on Longhorn
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    # --- STORAGE MIGRATION END ---

    retention: 2d               # Keeping your 2-day metrics setting
    retentionSize: "8GB"        # Keeping your 8GB limit
    
    # Ensures Prometheus looks for the PodMonitor you attached
    podMonitorSelectorNilUsesHelmValues: false
    podMonitorNamespaceSelector:
      any: true

    additionalScrapeConfigs:
      - job_name: 'namespace-filter-drop-list'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__address__]
            regex: '.*:(6379|5432)'
            action: drop
          - source_labels: [__meta_kubernetes_namespace]
            regex: 'kube-system|kube-public|monitoring|argocd|default|cattle-system|kube-node-lease'
            action: drop
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
            action: replace
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
            action: replace