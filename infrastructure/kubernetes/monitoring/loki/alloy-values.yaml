# infrastructure/kubernetes/monitoring/loki/alloy-values.yaml

agent:
  configMap:
    content: |
      // 1. Retrieve credentials from K8s Secret
      secret "loki_auth" {
        user = env("LOKI_USER")
        password = env("LOKI_PASS")
      }

      // 2. Loki write client
      loki.write "local" {
        endpoint {
          url = "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
          tenant_id = "production"

          basic_auth {
            username = secret.loki_auth.user
            password = secret.loki_auth.password
          }
        }

        forward_to = [loki.process.filter.receiver]
      }

      // 3. Kubernetes log source (auto discovers logs)
      loki.source.kubernetes "logs" {
        forward_to = [loki.process.filter.receiver]
      }

      // 4. Processing pipeline
      loki.process "filter" {
        forward_to = [loki.write.local.receiver]

        // Only KEEP production namespace logs
        stage {
          match {
            selector = "{namespace!=\"production\"}"
            action   = "drop"
          }
        }

        // Label cleanup
        stage {
          label_drop = [
            "__meta_kubernetes_pod_label_app_kubernetes_io_instance",
            "__meta_kubernetes_namespace",
            "__meta_kubernetes_pod_label_pod_template_hash",
            "__meta_kubernetes_pod_label_controller_revision_hash"
          ]
        }
      }

  hostPath:
    pods: /var/log/pods
    containers: /var/log/containers

extraEnv:
  - name: LOKI_USER
    valueFrom:
      secretKeyRef:
        name: loki-basic-auth
        key: username

  - name: LOKI_PASS
    valueFrom:
      secretKeyRef:
        name: loki-basic-auth
        key: password
