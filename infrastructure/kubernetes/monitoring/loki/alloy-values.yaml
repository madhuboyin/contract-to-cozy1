alloy:
  mode: daemonset

  mounts:
    varlog: true

  extraEnv:
    - name: LOKI_USERNAME
      valueFrom:
        secretKeyRef:
          name: loki-basic-auth
          key: username
    - name: LOKI_PASSWORD
      valueFrom:
        secretKeyRef:
          name: loki-basic-auth
          key: password

  configMap:
    content: |
      // --------------------------------------------------
      // 1. Kubernetes Pod Discovery
      // --------------------------------------------------
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // --------------------------------------------------
      // 2. Relabel: KEEP ONLY production namespace
      // --------------------------------------------------
      discovery.relabel "production_only" {
        targets = discovery.kubernetes.pods.targets

        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex         = "production"
          action        = "keep"
        }
      }

      // --------------------------------------------------
      // 3. Read container logs
      // --------------------------------------------------
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.production_only.output
        forward_to = [loki.process.k8s.receiver]
      }

      // --------------------------------------------------
      // 4. Add Kubernetes labels
      // --------------------------------------------------
      loki.process "k8s" {
        stage.kubernetes_labels {}

        forward_to = [loki.write.loki.receiver]
      }

      // --------------------------------------------------
      // 5. Write to Loki (via gateway + basic auth)
      // --------------------------------------------------
      loki.write "loki" {
        endpoint {
          url = "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"

          basic_auth {
            username = env("LOKI_USERNAME")
            password = env("LOKI_PASSWORD")
          }
        }
      }
