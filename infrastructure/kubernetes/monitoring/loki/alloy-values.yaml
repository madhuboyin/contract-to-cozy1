configMap:
  content: |
    // Load credentials from environment variables
    locals {
      loki_user = env("LOKI_USER")
      loki_pass = env("LOKI_PASS")
    }

    // Discover container logs on Kubernetes
    loki.source.kubernetes "prod_logs" {
      namespaces = ["production"]
      forward_to = [loki.process.clean.receiver]
    }

    // Process pipeline â€” FIX: Only drop truly unnecessary labels.
    // Removing the aggressive drops (like __meta_kubernetes_namespace and the wildcard)
    // allows critical labels (namespace, app, pod) to be promoted for querying.
    loki.process "clean" {
      stage {
        label_drop = [
          "__meta_kubernetes_pod_label_app_kubernetes_io_instance"
          // Removed "__meta_kubernetes_namespace" and "__meta_kubernetes_pod_label_*"
        ]
      }
      forward_to = [loki.write.default.receiver]
    }

    // Output to Loki with basic auth
    loki.write "default" {
      endpoint {
        url = "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
        basic_auth {
          username = local.loki_user
          password = local.loki_pass
        }
      }
    }

extraEnv:
  - name: LOKI_USER
    valueFrom:
      secretKeyRef:
        name: loki-basic-auth
        key: username
  - name: LOKI_PASS
    valueFrom:
      secretKeyRef:
        name: loki-basic-auth
        key: password