# infrastructure/kubernetes/monitoring/loki/alloy-values.yaml

agent:
  configMap:
    content: |
      # ===============================================
      # 1. Read Basic Auth credentials from Secret
      # ===============================================
      secret "loki_auth" {
        user     = env("LOKI_USER")
        password = env("LOKI_PASS")
      }

      # ===============================================
      # 2. Discover Kubernetes logs
      # ===============================================
      loki.source.kubernetes "logs" {
        forward_to = [loki.process.filter.receiver]
      }

      # ===============================================
      # 3. Process logs (Filter â†’ Keep only production)
      # ===============================================
      loki.process "filter" {
        forward_to = [loki.write.default.receiver]

        # DROP everything NOT in production
        stage {
          match {
            selector = "{__meta_kubernetes_namespace!=\"production\"}"
            action   = "drop"
          }
        }

        # Optional cleanup of noisy metadata labels
        stage {
          label_drop = [
            "__meta_kubernetes_pod_label_*",
            "__meta_kubernetes_node_name",
            "__meta_kubernetes_pod_uid",
            "__meta_kubernetes_pod_annotation_*",
          ]
        }
      }

      # ===============================================
      # 4. Write logs to Loki with Basic Auth
      # ===============================================
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push"
          tenant_id = "production"
          basic_auth {
            username = secret.loki_auth.user
            password = secret.loki_auth.password
          }
        }
      }

  hostPath:
    pods: /var/log/pods
    containers: /var/log/containers

# 2. Inject environment variables for the Secret
extraEnv:
- name: LOKI_USER
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: username
- name: LOKI_PASS
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: password
