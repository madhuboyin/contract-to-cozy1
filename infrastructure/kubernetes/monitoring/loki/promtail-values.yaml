# In infrastructure/kubernetes/monitoring/loki/promtail-values.yaml

config:
  # This clients section is needed for Promtail to know where to send the logs
  clients:
    - url: http://loki-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push 
      basic_auth:
        username: ${LOKI_USER}
        password: ${LOKI_PASS}
      headers:
        X-Scope-OrgID: fake

  snippets:
    # ðŸ’¥ FIX: Inject the filter into the default relabeling chain using 'extraRelabelConfigs'
    extraRelabelConfigs:
      # 1. NEW STRICT FILTER: Keep ONLY targets where namespace is 'production'
      # This rule runs first. If the namespace is not 'production', the scrape target is dropped.
      - source_labels: [__meta_kubernetes_namespace]
        regex: production
        action: keep
      
      # 2. Add the rule to promote the namespace meta label to a permanent label.
      # This rule is critical and often included in the default chart config, but it's safest to keep it.
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace

# The remaining sections (extraEnv, extraArgs) must remain the same
extraEnv:
- name: LOKI_USER
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: username
- name: LOKI_PASS
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: password

extraArgs:
  - -config.expand-env=true