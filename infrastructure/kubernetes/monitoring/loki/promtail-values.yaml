# In infrastructure/kubernetes/monitoring/loki/promtail-values.yaml

config:
  clients:
    # This section is needed for Prometheus service discovery to work correctly
    - url: http://loki-gateway.monitoring.svc.cluster.local:80/loki/api/v1/push 
      basic_auth:
        username: ${LOKI_USER}
        password: ${LOKI_PASS}
      headers:
        X-Scope-OrgID: fake

  snippets:
    # ðŸ’¥ CRITICAL FIX: This section is changed to implement a strict "keep: production" filter ðŸ’¥
    relabel_configs:
      # 1. NEW STRICT FILTER: Keep ONLY targets where namespace is 'production'
      # All other namespaces (including monitoring, kube-system, etc.) are dropped here.
      - source_labels: [__meta_kubernetes_namespace]
        regex: production
        action: keep

      # 2. STANDARD LABELS FOLLOW (The chart will append its defaults below this)
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      
      # NOTE: Do NOT include the full list of labeling rules here. The chart handles that.

# --- Inject Secret and Args (As before) ---
extraEnv:
- name: LOKI_USER
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: username
- name: LOKI_PASS
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: password

extraArgs:
  - -config.expand-env=true