config:
  clients:
    - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
      basic_auth:
        username: ${LOKI_USER}
        password: ${LOKI_PASS}
      # 2. Add the required X-Scope-OrgID header
      headers:
        X-Scope-OrgID: fake
  snippets:
    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          # ðŸ’¥ CRITICAL FIX: THIS MUST BE THE FIRST RULE ðŸ’¥
          # Drop logs from infrastructure and system namespaces:
          - source_labels: [__meta_kubernetes_namespace]
            regex: kube-system|kube-public|kube-node-lease|monitoring|admin-tools|cattle-fleet-system|cattle-system|argocd
            action: drop
            
          # 2. Standard rule to create the 'namespace' label (Must come AFTER the drop rule)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
            
          # 3. All other labeling rules follow below:
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_uid]
            target_label: pod_uid
          - source_labels: [__meta_kubernetes_container_name]
            target_label: container
          - action: replace
            replacement: "/var/log/pods/*$1/*.log"
            source_labels: [__meta_kubernetes_pod_uid]
            target_label: __path__

clients:
  - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
    basic_auth:
      username: ${LOKI_USER}
      password: ${LOKI_PASS}
    # 2. Add the required X-Scope-OrgID header
    headers:
      X-Scope-OrgID: fake

# ðŸ’¥ ADDITIONS: Inject Secret into Promtail Pods ðŸ’¥
extraArgs:
  # Enable environment variable expansion in Promtail config
  - -config.expand-env=true

extraEnv:
- name: LOKI_USER
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: username # Must exist in your secret
- name: LOKI_PASS
  valueFrom:
    secretKeyRef:
      name: loki-basic-auth
      key: password # Must exist in your secret