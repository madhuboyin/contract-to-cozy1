apiVersion: v1
kind: ConfigMap
metadata:
  name: prisma-schema
  namespace: production
data:
  schema.prisma: |
    generator client {
      provider = "prisma-client-js"
    }
    datasource db {
      provider = "postgresql"
      url      = env("DATABASE_URL")
    }
    enum UserRole {
      HOMEOWNER
      PROVIDER
      ADMIN
    }
    enum UserStatus {
      ACTIVE
      INACTIVE
      SUSPENDED
      PENDING_VERIFICATION
    }
    enum ServiceCategory {
      INSPECTION
      HANDYMAN
    }
    enum InspectionType {
      HOME_INSPECTION
      PEST_INSPECTION
      RADON_TESTING
      MOLD_INSPECTION
      WELL_SEPTIC_INSPECTION
      ROOF_INSPECTION
      FOUNDATION_INSPECTION
      ELECTRICAL_INSPECTION
      PLUMBING_INSPECTION
    }
    enum HandymanType {
      MINOR_REPAIRS
      FIXTURE_INSTALLATION
      FURNITURE_ASSEMBLY
      DRYWALL_REPAIR
      DOOR_WINDOW_REPAIR
      DECK_FENCE_REPAIR
      GENERAL_MAINTENANCE
      PAINTING_TOUCHUP
      CAULKING_SEALING
    }
    enum BookingStatus {
      DRAFT
      PENDING
      CONFIRMED
      IN_PROGRESS
      COMPLETED
      CANCELLED
      DISPUTED
    }
    enum PaymentStatus {
      PENDING
      AUTHORIZED
      CAPTURED
      REFUNDED
      FAILED
      CANCELLED
    }
    enum DocumentType {
      INSPECTION_REPORT
      ESTIMATE
      INVOICE
      CONTRACT
      PERMIT
      PHOTO
      VIDEO
      INSURANCE_CERTIFICATE
      LICENSE
      OTHER
    }
    enum MessageType {
      TEXT
      SYSTEM
      BOOKING_UPDATE
      PAYMENT_UPDATE
    }
    enum ReviewStatus {
      PENDING
      APPROVED
      REJECTED
      FLAGGED
    }
    enum ProviderStatus {
      PENDING_APPROVAL
      ACTIVE
      INACTIVE
      SUSPENDED
    }
    model User {
      id        String     @id @default(uuid())
      email     String     @unique
      phone     String?
      firstName String
      lastName  String
      role      UserRole   @default(HOMEOWNER)
      status    UserStatus @default(ACTIVE)
      passwordHash String
      emailVerified Boolean @default(false)
      phoneVerified Boolean @default(false)
      avatar       String?
      bio          String?
      address      Address?
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      lastLoginAt DateTime?
      homeownerProfile HomeownerProfile?
      providerProfile  ProviderProfile?
      bookings         Booking[]        @relation("BookingHomeowner")
      providerBookings Booking[]        @relation("BookingProvider")
      reviews          Review[]         @relation("ReviewAuthor")
      receivedReviews  Review[]         @relation("ReviewProvider")
      messages         Message[]
      notifications    Notification[]
      favorites        Favorite[]
      @@index([email])
      @@index([role])
      @@index([status])
      @@map("users")
    }
    model Address {
      id      String  @id @default(uuid())
      userId  String  @unique
      street1     String
      street2     String?
      city        String
      state       String
      zipCode     String
      country     String @default("USA")
      latitude    Float?
      longitude   Float?
      user User @relation(fields: [userId], references: [id], onDelete: Cascade)
      @@index([zipCode])
      @@index([city, state])
      @@map("addresses")
    }
    model HomeownerProfile {
      id     String @id @default(uuid())
      userId String @unique
      propertyType        String?
      propertySize        Int?
      yearBuilt           Int?
      bedrooms            Int?
      bathrooms           Float?
      closingDate         DateTime?
      purchasePrice       Decimal?  @db.Decimal(12, 2)
      preferredContactMethod String?
      notificationPreferences Json?
      totalBudget         Decimal?  @db.Decimal(12, 2)
      spentAmount         Decimal   @default(0) @db.Decimal(12, 2)
      user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
      properties  Property[]
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@map("homeowner_profiles")
    }
    model Property {
      id                 String   @id @default(uuid())
      homeownerProfileId String
      name        String?
      address     String
      city        String
      state       String
      zipCode     String
      isPrimary   Boolean  @default(true)
      homeownerProfile HomeownerProfile @relation(fields: [homeownerProfileId], references: [id], onDelete: Cascade)
      bookings         Booking[]
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([homeownerProfileId])
      @@map("properties")
    }
    model ProviderProfile {
      id     String @id @default(uuid())
      userId String @unique
      businessName        String
      businessType        String?
      taxId               String?
      serviceCategories   ServiceCategory[]
      serviceRadius       Int      @default(25)
      status              ProviderStatus @default(PENDING_APPROVAL)
      backgroundCheckDate DateTime?
      insuranceVerified   Boolean        @default(false)
      licenseVerified     Boolean        @default(false)
      yearsInBusiness     Int?
      teamSize            Int?
      description         String?
      website             String?
      averageRating       Float    @default(0) @db.Real
      totalReviews        Int      @default(0)
      totalCompletedJobs  Int      @default(0)
      availabilitySchedule Json?
      stripeAccountId     String?  @unique
      stripeOnboarded     Boolean  @default(false)
      user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
      services           Service[]
      certifications     Certification[]
      portfolioImages    ProviderPortfolio[]
      bookings           Booking[]
      availability       ProviderAvailability[]
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([status])
      @@index([userId])
      @@map("provider_profiles")
    }
    model Certification {
      id                String   @id @default(uuid())
      providerProfileId String
      name              String
      issuingAuthority  String
      certificateNumber String?
      issueDate         DateTime
      expiryDate        DateTime?
      documentUrl       String?
      verified          Boolean  @default(false)
      providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([providerProfileId])
      @@map("certifications")
    }
    model ProviderPortfolio {
      id                String  @id @default(uuid())
      providerProfileId String
      title             String
      description       String?
      imageUrl          String
      category          ServiceCategory
      providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      @@index([providerProfileId])
      @@map("provider_portfolio")
    }
    model ProviderAvailability {
      id                String   @id @default(uuid())
      providerProfileId String
      startDate         DateTime
      endDate           DateTime
      isAvailable       Boolean  @default(true)
      reason            String?
      providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([providerProfileId])
      @@index([startDate, endDate])
      @@map("provider_availability")
    }
    model Service {
      id                String          @id @default(uuid())
      providerProfileId String
      category          ServiceCategory
      inspectionType    InspectionType?
      handymanType      HandymanType?
      name              String
      description       String
      basePrice         Decimal         @db.Decimal(10, 2)
      priceUnit         String
      minimumCharge     Decimal?        @db.Decimal(10, 2)
      isActive          Boolean         @default(true)
      estimatedDuration Int?
      providerProfile ProviderProfile @relation(fields: [providerProfileId], references: [id], onDelete: Cascade)
      bookings        Booking[]
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([providerProfileId])
      @@index([category])
      @@index([isActive])
      @@map("services")
    }
    model Booking {
      id          String        @id @default(uuid())
      homeownerId String
      providerId  String
      propertyId  String
      serviceId   String
      category          ServiceCategory
      inspectionType    InspectionType?
      handymanType      HandymanType?
      status            BookingStatus   @default(PENDING)
      bookingNumber     String          @unique
      scheduledDate     DateTime
      estimatedDuration Int
      actualDuration    Int?
      estimatedCost     Decimal         @db.Decimal(10, 2)
      actualCost        Decimal?        @db.Decimal(10, 2)
      notes             String?
      internalNotes     String?
      completedAt       DateTime?
      cancelledAt       DateTime?
      cancellationReason String?
      homeowner User             @relation("BookingHomeowner", fields: [homeownerId], references: [id])
      provider  ProviderProfile  @relation(fields: [providerId], references: [id])
      property  Property         @relation(fields: [propertyId], references: [id])
      service   Service          @relation(fields: [serviceId], references: [id])
      payments  Payment[]
      documents Document[]
      messages  Message[]
      review    Review?
      timeline  BookingTimeline[]
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([homeownerId])
      @@index([providerId])
      @@index([status])
      @@index([scheduledDate])
      @@index([category])
      @@map("bookings")
    }
    model BookingTimeline {
      id        String   @id @default(uuid())
      bookingId String
      status    BookingStatus
      note      String?
      createdBy String?
      booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      @@index([bookingId])
      @@map("booking_timeline")
    }
    model Payment {
      id          String        @id @default(uuid())
      bookingId   String
      amount      Decimal       @db.Decimal(10, 2)
      currency    String        @default("USD")
      status      PaymentStatus @default(PENDING)
      isDeposit   Boolean       @default(false)
      stripePaymentIntentId String? @unique
      stripeChargeId        String? @unique
      description String?
      failureReason String?
      refundedAmount Decimal? @db.Decimal(10, 2)
      refundedAt     DateTime?
      booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([bookingId])
      @@index([status])
      @@map("payments")
    }
    model Document {
      id          String       @id @default(uuid())
      bookingId   String?
      uploadedBy  String
      type        DocumentType
      name        String
      description String?
      fileUrl     String
      fileSize    Int
      mimeType    String
      metadata    Json?
      booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([bookingId])
      @@index([type])
      @@map("documents")
    }
    model Message {
      id          String      @id @default(uuid())
      bookingId   String?
      senderId    String
      recipientId String
      type        MessageType @default(TEXT)
      content     String
      attachments Json?
      isRead      Boolean     @default(false)
      readAt      DateTime?
      booking   Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
      sender    User     @relation(fields: [senderId], references: [id])
      createdAt DateTime @default(now())
      @@index([bookingId])
      @@index([senderId])
      @@index([recipientId])
      @@index([createdAt])
      @@map("messages")
    }
    model Review {
      id          String       @id @default(uuid())
      bookingId   String       @unique
      authorId    String
      providerId  String
      rating      Int
      title       String?
      content     String
      qualityRating      Int?
      communicationRating Int?
      valueRating        Int?
      professionalismRating Int?
      status      ReviewStatus @default(PENDING)
      moderatedAt DateTime?
      moderatedBy String?
      response    String?
      respondedAt DateTime?
      booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
      author   User    @relation("ReviewAuthor", fields: [authorId], references: [id])
      provider User    @relation("ReviewProvider", fields: [providerId], references: [id])
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      @@index([providerId])
      @@index([rating])
      @@index([status])
      @@map("reviews")
    }
    model Notification {
      id       String  @id @default(uuid())
      userId   String
      type     String
      title    String
      message  String
      actionUrl String?
      isRead   Boolean @default(false)
      readAt   DateTime?
      metadata Json?
      user User @relation(fields: [userId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      @@index([userId])
      @@index([isRead])
      @@index([createdAt])
      @@map("notifications")
    }
    model Favorite {
      id                String   @id @default(uuid())
      userId            String
      providerProfileId String
      user User @relation(fields: [userId], references: [id], onDelete: Cascade)
      createdAt DateTime @default(now())
      @@unique([userId, providerProfileId])
      @@index([userId])
      @@map("favorites")
    }
    model AuditLog {
      id         String   @id @default(uuid())
      userId     String?
      action     String
      entityType String
      entityId   String
      oldValues  Json?
      newValues  Json?
      ipAddress  String?
      userAgent  String?
      createdAt DateTime @default(now())
      @@index([userId])
      @@index([entityType, entityId])
      @@index([createdAt])
      @@map("audit_logs")
    }
    model SystemSetting {
      id    String @id @default(uuid())
      key   String @unique
      value Json
      description String?
      updatedAt DateTime @updatedAt
      @@map("system_settings")
    }

---
apiVersion: batch/v1
kind: Job
metadata:
  name: prisma-migrate
  namespace: production
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: migrate
        image: node:20-alpine
        command:
          - sh
          - -c
          - |
            set -e
            echo "üì¶ Installing dependencies..."
            apk add --no-cache openssl openssl-dev
            npm install -g prisma@5.22.0
            
            echo "üìã Setting up schema..."
            mkdir -p /app/prisma
            cp /config/schema.prisma /app/prisma/schema.prisma
            
            cd /app
            
            echo "üîç Checking database connection..."
            timeout 10 npx prisma db execute --stdin <<'EOF' || echo "Connection check skipped"
            SELECT version();
            EOF
            
            echo "üöÄ Running migration..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "‚úÖ Migration complete!"
            echo ""
            echo "üìä Listing tables:"
            npx prisma db execute --stdin <<'EOF'
            SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;
            EOF
        env:
        - name: DATABASE_URL
          value: "postgresql://postgres:YOUR_PASSWORD_HERE@postgres.production.svc.cluster.local:5432/contracttocozy?schema=public"
      volumes:
      - name: schema
        configMap:
          name: prisma-schema
